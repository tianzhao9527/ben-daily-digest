<!doctype html>
<html lang="zh-CN"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>{{TITLE}}</title>
<style>
:root{--bg:#f5f5f7;--card:#fff;--text:#1d1d1f;--muted:#86868b;--line:rgba(0,0,0,.06);--shadow:0 2px 12px rgba(0,0,0,.04);--r:14px;--accent:#0071e3;--chip:rgba(0,0,0,.03);--success:#34c759;--danger:#ff3b30;--warning:#ff9500;--font:-apple-system,BlinkMacSystemFont,"SF Pro Text","PingFang SC",system-ui,sans-serif}
[data-theme="dark"]{--bg:#000;--card:rgba(28,28,30,.92);--text:#f5f5f7;--muted:#98989d;--line:rgba(255,255,255,.08);--shadow:0 4px 24px rgba(0,0,0,.3);--chip:rgba(255,255,255,.05)}
*{box-sizing:border-box;margin:0;padding:0}html,body{height:100%;font-family:var(--font);-webkit-font-smoothing:antialiased}
body{background:var(--bg);color:var(--text);font-size:13px;line-height:1.5}a{color:var(--accent);text-decoration:none}a:hover{text-decoration:underline}
.container{max-width:1480px;margin:0 auto;padding:12px;display:grid;gap:12px;grid-template-columns:260px minmax(0,1fr) 340px;height:100vh;overflow:hidden}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}
.left{min-height:0}.brand{padding:16px 14px;border-bottom:1px solid var(--line)}.brand-title{font-size:15px;font-weight:600}.brand-sub{margin-top:4px;font-size:11px;color:var(--muted)}
.controls{padding:10px 14px;border-bottom:1px solid var(--line)}.search{width:100%;border:1px solid var(--line);background:var(--chip);padding:8px 10px;border-radius:8px;outline:none;color:var(--text);font-size:12px}.search:focus{border-color:var(--accent)}
.pills{display:flex;gap:6px;margin-top:8px}.pill{font-size:11px;padding:5px 10px;border-radius:16px;border:1px solid var(--line);color:var(--muted);background:transparent;cursor:pointer;font-family:var(--font)}.pill:hover{background:var(--chip)}.pill.active{color:#fff;border-color:var(--accent);background:var(--accent)}
.nav{flex:1;overflow:auto;padding:6px}.nav-item{display:flex;align-items:center;gap:8px;padding:10px;border-radius:10px;cursor:pointer;margin-bottom:2px}.nav-item:hover{background:var(--chip)}.nav-item.active{background:var(--accent);color:#fff}
.nav-icon{font-size:16px;width:24px;text-align:center}.nav-label{flex:1;font-size:12px;font-weight:500}.nav-badge{min-width:18px;height:18px;padding:0 5px;font-size:10px;font-weight:600;background:var(--chip);border-radius:9px;display:flex;align-items:center;justify-content:center}.nav-item.active .nav-badge{background:rgba(255,255,255,.2)}
.main{min-height:0;display:flex;flex-direction:column}.topbar{padding:12px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:12px}.topbar-title{font-size:16px;font-weight:600}.topbar-meta{margin-left:auto;display:flex;align-items:center;gap:6px}
.date-picker-btn{background:var(--chip);border:1px solid var(--line);border-radius:6px;padding:4px 10px;font-size:11px;color:var(--text);cursor:pointer;display:flex;align-items:center;gap:4px;font-family:var(--font)}.date-picker-btn:hover{border-color:var(--accent)}
.date-dropdown{position:absolute;top:100%;right:0;margin-top:4px;background:var(--card);border:1px solid var(--line);border-radius:8px;box-shadow:var(--shadow);z-index:100;min-width:160px;max-height:300px;overflow:auto;display:none}.date-dropdown.show{display:block}
.date-dropdown-item{padding:8px 12px;font-size:12px;cursor:pointer}.date-dropdown-item:hover{background:var(--chip)}.date-dropdown-item.active{color:var(--accent);font-weight:500}
.feed{flex:1;overflow:auto;padding:12px}.section-header{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--line);margin-bottom:10px}
.section-icon{font-size:18px}.section-title{font-size:14px;font-weight:600}.section-badge{font-size:10px;padding:2px 8px;border-radius:10px;background:rgba(0,113,227,.1);color:var(--accent)}
.section-sentiment{margin-left:auto;display:flex;align-items:center;gap:4px;font-size:11px}.sentiment-dot{width:8px;height:8px;border-radius:50%}.sentiment-positive{background:var(--success)}.sentiment-negative{background:var(--danger)}.sentiment-neutral{background:var(--muted)}
.brief{background:linear-gradient(135deg,rgba(0,113,227,.03),rgba(0,113,227,.06));border:1px solid rgba(0,113,227,.1);border-radius:10px;padding:12px;margin-bottom:12px;font-size:12px;line-height:1.7}.brief-title{font-weight:600;color:var(--accent);margin-bottom:6px}
.keywords-row{display:flex;flex-wrap:wrap;gap:4px;margin-top:8px}.keyword-tag{font-size:10px;padding:2px 8px;border-radius:10px;background:var(--chip);color:var(--muted)}
.event-card{padding:12px;border:1px solid var(--line);border-radius:10px;margin-bottom:8px}.event-card:hover{border-color:var(--accent)}.event-card.cn{border-left:3px solid var(--danger)}
.event-meta{display:flex;align-items:center;gap:6px;margin-bottom:6px}.event-region{font-size:10px;padding:1px 6px;border-radius:4px;background:var(--chip);color:var(--muted)}.event-region.cn{background:rgba(255,59,48,.1);color:var(--danger)}
.event-date{font-size:10px;color:var(--muted)}.event-score{margin-left:auto;font-size:10px;color:var(--muted)}.event-title{font-size:13px;font-weight:600;margin-bottom:4px}.event-summary{font-size:12px;color:var(--muted);line-height:1.6}
.event-sources{margin-top:8px;display:flex;flex-wrap:wrap;gap:4px}.source-chip{font-size:10px;padding:3px 8px;background:var(--chip);border-radius:12px;color:var(--muted)}.source-chip:hover{color:var(--accent)}.source-count{font-size:9px;background:var(--accent);color:#fff;padding:1px 5px;border-radius:8px;margin-left:2px}
.right{min-height:0;display:flex;flex-direction:column}.right-header{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}.right-title{font-size:13px;font-weight:600}
.right-tabs{display:flex;gap:4px}.right-tab{font-size:11px;padding:4px 10px;border-radius:6px;cursor:pointer;background:transparent;border:none;color:var(--muted);font-family:var(--font)}.right-tab:hover{background:var(--chip)}.right-tab.active{background:var(--accent);color:#fff}
.right-content{flex:1;overflow:auto;padding:10px}
.sentiment-dashboard{padding:12px;background:var(--chip);border-radius:10px;margin-bottom:12px}
.sentiment-gauge{width:120px;height:60px;margin:0 auto 8px;position:relative}
.gauge-bg{width:120px;height:60px;border-radius:60px 60px 0 0;background:linear-gradient(90deg,var(--danger) 0%,var(--warning) 50%,var(--success) 100%);position:relative;overflow:hidden}
.gauge-mask{position:absolute;bottom:0;left:10px;right:10px;height:40px;background:var(--chip);border-radius:50px 50px 0 0}
.gauge-needle{position:absolute;bottom:0;left:50%;width:4px;height:50px;background:var(--text);transform-origin:bottom center;border-radius:2px;margin-left:-2px;transition:transform .5s}
.gauge-center{position:absolute;bottom:-5px;left:50%;width:16px;height:16px;background:var(--card);border:2px solid var(--text);border-radius:50%;margin-left:-8px}
.sentiment-value{text-align:center;font-size:20px;font-weight:600}.sentiment-label{text-align:center;font-size:11px;color:var(--muted)}
.sentiment-breakdown{display:flex;justify-content:space-around;margin-top:10px}.sentiment-item{text-align:center}.sentiment-item-value{font-size:14px;font-weight:600}.sentiment-item-label{font-size:10px;color:var(--muted)}
.wordcloud{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;padding:12px;min-height:80px}
.word-item{padding:4px 10px;border-radius:12px;font-weight:500;cursor:default}.word-item:hover{transform:scale(1.1)}
.word-size-1{font-size:10px;background:rgba(0,113,227,.05);color:rgba(0,113,227,.6)}.word-size-2{font-size:12px;background:rgba(0,113,227,.1);color:rgba(0,113,227,.7)}.word-size-3{font-size:14px;background:rgba(0,113,227,.15);color:rgba(0,113,227,.8)}.word-size-4{font-size:16px;background:rgba(0,113,227,.2);color:var(--accent)}.word-size-5{font-size:18px;background:rgba(0,113,227,.25);color:var(--accent);font-weight:600}
.heatmap{padding:12px}.heatmap-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:2px}
.heatmap-cell{aspect-ratio:1;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:9px;color:var(--muted)}
.heatmap-cell[data-count="0"]{background:var(--chip)}.heatmap-cell[data-count="1"]{background:rgba(0,113,227,.15)}.heatmap-cell[data-count="2"]{background:rgba(0,113,227,.3)}.heatmap-cell[data-count="3"]{background:rgba(0,113,227,.45)}.heatmap-cell[data-count="4"]{background:rgba(0,113,227,.6);color:#fff}.heatmap-cell[data-count="5"]{background:rgba(0,113,227,.8);color:#fff}
.heatmap-labels{display:flex;justify-content:space-between;margin-top:6px;font-size:9px;color:var(--muted)}
.kpi-section{padding:10px;border-bottom:1px solid var(--line)}.kpi-section:last-child{border-bottom:none}
.kpi-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}.kpi-title{font-size:11px;font-weight:500}.kpi-value{font-size:16px;font-weight:600}
.kpi-change{font-size:10px;margin-left:6px}.kpi-change.up{color:var(--success)}.kpi-change.down{color:var(--danger)}
.kpi-chart{height:50px;position:relative}.kpi-chart canvas{width:100%!important;height:100%!important}
.kpi-indicators{display:flex;gap:8px;margin-top:4px;font-size:9px;color:var(--muted)}.kpi-ma{display:flex;align-items:center;gap:3px}.kpi-ma-dot{width:6px;height:2px;border-radius:1px}.kpi-ma-dot.ma5{background:#ff9500}.kpi-ma-dot.ma20{background:#af52de}.kpi-support{color:var(--success)}.kpi-resist{color:var(--danger)}
.kpi-group{margin-bottom:8px}.kpi-group-header{display:flex;align-items:center;gap:6px;padding:8px 10px;background:var(--chip);border-radius:8px;cursor:pointer;font-size:11px;font-weight:500}.kpi-group-header:hover{background:rgba(0,0,0,.06)}
.kpi-group-icon{transition:transform .2s}.kpi-group.collapsed .kpi-group-icon{transform:rotate(-90deg)}.kpi-group-count{margin-left:auto;font-size:10px;color:var(--muted)}.kpi-group-items{padding:6px 0}.kpi-group.collapsed .kpi-group-items{display:none}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:500;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px)}.modal.show{display:flex}
.modal-box{background:var(--card);border-radius:16px;width:100%;max-width:680px;max-height:85vh;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.2)}
.modal-header{padding:16px 20px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}.modal-title{font-size:16px;font-weight:600}
.modal-close{width:28px;height:28px;border-radius:50%;border:none;background:var(--chip);cursor:pointer;font-size:16px;color:var(--muted);display:flex;align-items:center;justify-content:center}.modal-close:hover{background:var(--line)}
.modal-tabs{display:flex;gap:0;border-bottom:1px solid var(--line);padding:0 20px}
.modal-tab{padding:12px 16px;font-size:12px;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;background:none;border-left:none;border-right:none;border-top:none;font-family:var(--font)}.modal-tab:hover{color:var(--text)}.modal-tab.active{color:var(--accent);border-bottom-color:var(--accent);font-weight:500}
.modal-body{flex:1;overflow:auto;padding:16px 20px}.tab-pane{display:none}.tab-pane.active{display:block}
.editor-item{display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--chip);border:1px solid var(--line);border-radius:8px;margin-bottom:6px}.editor-item:hover{border-color:var(--accent)}
.editor-item-main{flex:1;min-width:0}.editor-item-title{font-size:12px;font-weight:500}.editor-item-sub{font-size:10px;color:var(--muted);margin-top:2px}
.editor-item-actions{display:flex;gap:4px}.editor-btn{width:28px;height:28px;border-radius:6px;border:none;background:transparent;cursor:pointer;font-size:14px;color:var(--muted);display:flex;align-items:center;justify-content:center}.editor-btn:hover{background:var(--chip);color:var(--text)}.editor-btn.danger:hover{color:var(--danger)}
.editor-input{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:6px;background:var(--card);color:var(--text);font-size:12px;font-family:var(--font)}.editor-input:focus{outline:none;border-color:var(--accent)}
.editor-add{width:100%;padding:12px;border:2px dashed var(--accent);border-radius:8px;background:rgba(0,113,227,.03);cursor:pointer;font-size:13px;color:var(--accent);font-weight:500;display:flex;align-items:center;justify-content:center;gap:6px}.editor-add:hover{color:#fff;background:var(--accent)}
.editor-form{padding:12px;background:var(--chip);border-radius:8px;margin:10px 0}.editor-form-row{display:flex;gap:8px;margin-bottom:8px}.editor-form-row:last-child{margin-bottom:0}.editor-form-label{font-size:11px;color:var(--muted);margin-bottom:4px;display:block}.editor-form-group{flex:1}
.btn{padding:8px 16px;border-radius:8px;border:1px solid var(--line);background:var(--card);color:var(--text);font-size:12px;cursor:pointer;font-family:var(--font)}.btn:hover{border-color:var(--accent);color:var(--accent)}.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}.btn.primary:hover{opacity:.9}
.export-btns{display:flex;gap:8px;margin-top:12px}.export-btns .btn{flex:1}
.github-sync{padding:12px;background:linear-gradient(135deg,rgba(0,113,227,.05),rgba(0,113,227,.1));border-radius:10px;margin-top:12px}
.github-sync-title{font-size:12px;font-weight:500;margin-bottom:8px}.github-sync-desc{font-size:11px;color:var(--muted);margin-bottom:10px;line-height:1.5}
.github-sync-input{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:6px;background:var(--card);color:var(--text);font-size:11px;font-family:monospace;margin-bottom:8px}
.github-sync-btn{width:100%;padding:10px;border:none;border-radius:8px;background:var(--accent);color:#fff;font-size:12px;font-weight:500;cursor:pointer;font-family:var(--font)}.github-sync-btn:hover{opacity:.9}.github-sync-btn:disabled{opacity:.5;cursor:not-allowed}
.github-sync-status{margin-top:8px;font-size:11px;padding:8px;border-radius:6px}.github-sync-status.success{background:rgba(52,199,89,.1);color:var(--success)}.github-sync-status.error{background:rgba(255,59,48,.1);color:var(--danger)}.github-sync-status.pending{background:rgba(255,149,0,.1);color:var(--warning)}
@media (max-width:1200px){.container{grid-template-columns:240px 1fr}.right{display:none}}
@media (max-width:900px){.container{grid-template-columns:1fr;height:auto;min-height:100vh;padding-bottom:70px}.left{display:none !important}.right{display:none !important}.left.mobile-show,.right.mobile-show{display:flex !important;position:fixed;top:0;left:0;right:0;bottom:60px;z-index:200;border-radius:0;overflow-y:auto}.mobile-close{display:block !important;position:absolute;top:12px;right:12px;z-index:10}.main{height:auto;min-height:calc(100vh - 82px)}}
.mobile-close{display:none}.mobile-nav{display:none;position:fixed;bottom:0;left:0;right:0;height:60px;background:var(--card);border-top:1px solid var(--line);z-index:300;justify-content:space-around;align-items:center;padding:0 20px}
@media (max-width:900px){.mobile-nav{display:flex}}
.mobile-nav-item{display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 16px;border-radius:10px;cursor:pointer;border:none;background:transparent;color:var(--muted);font-family:var(--font)}.mobile-nav-item:hover,.mobile-nav-item.active{background:var(--chip);color:var(--accent)}
.mobile-nav-icon{font-size:20px}.mobile-nav-label{font-size:10px}
</style>
</head>
<body>
<div class="container">
<aside class="card left"><button class="mobile-close" onclick="this.parentElement.classList.remove('mobile-show')">Ã—</button>
<div class="brand"><div class="brand-title">ğŸ“Š æ™ºèƒ½ç®€æŠ¥</div><div class="brand-sub">v3.0 Â· å»é‡ Â· æƒ…æ„Ÿåˆ†æ Â· è‡ªåŠ¨åŒæ­¥</div></div>
<div class="controls"><input type="text" class="search" placeholder="æœç´¢æ–°é—»..." id="searchInput"/><div class="pills"><button class="pill active" data-filter="all">å…¨éƒ¨</button><button class="pill" data-filter="cn">ğŸ‡¨ğŸ‡³ ä¸­å›½</button><button class="pill" data-filter="global">ğŸŒ å…¨çƒ</button></div></div>
<nav class="nav" id="navList"></nav></aside>
<main class="card main"><div class="topbar"><span class="topbar-title" id="currentSection">ä»Šæ—¥è¦é—»</span><div class="topbar-meta" style="position:relative"><button class="date-picker-btn" id="datePickerBtn"><span id="pageDate">{{DATE}}</span><span style="font-size:8px;color:var(--muted)">â–¾</span></button><div class="date-dropdown" id="dateDropdown"><div id="dateList"></div></div><button class="pill" id="themeBtn">ğŸŒ“</button><button class="pill" id="settingsBtn">âš™ï¸</button></div></div><div class="feed" id="feed"></div></main>
<aside class="card right"><button class="mobile-close" onclick="this.parentElement.classList.remove('mobile-show')">Ã—</button>
<div class="right-header"><span class="right-title">æ•°æ®é¢æ¿</span><div class="right-tabs"><button class="right-tab active" data-panel="sentiment">æƒ…ç»ª</button><button class="right-tab" data-panel="kpi">æŒ‡æ ‡</button><button class="right-tab" data-panel="heatmap">çƒ­åŠ›</button></div></div>
<div class="right-content">
<div class="panel-content" id="panel-sentiment"><div class="sentiment-dashboard"><div class="sentiment-gauge"><div class="gauge-bg"><div class="gauge-mask"></div><div class="gauge-needle" id="gaugeNeedle"></div><div class="gauge-center"></div></div></div><div class="sentiment-value" id="sentimentValue">0.50</div><div class="sentiment-label">å¸‚åœºæƒ…ç»ªæŒ‡æ•°</div><div class="sentiment-breakdown"><div class="sentiment-item"><div class="sentiment-item-value" id="sentimentPositive" style="color:var(--success)">0</div><div class="sentiment-item-label">çœ‹å¤š</div></div><div class="sentiment-item"><div class="sentiment-item-value" id="sentimentNeutral">0</div><div class="sentiment-item-label">ä¸­æ€§</div></div><div class="sentiment-item"><div class="sentiment-item-value" id="sentimentNegative" style="color:var(--danger)">0</div><div class="sentiment-item-label">çœ‹ç©º</div></div></div></div><div style="font-size:11px;font-weight:500;margin:12px 0 8px;color:var(--muted)">çƒ­é—¨å…³é”®è¯</div><div class="wordcloud" id="wordcloud"></div></div>
<div class="panel-content" id="panel-kpi" style="display:none"><div id="kpiList"></div></div>
<div class="panel-content" id="panel-heatmap" style="display:none"><div style="font-size:11px;font-weight:500;margin-bottom:8px">æ–°é—»åˆ†å¸ƒçƒ­åŠ›å›¾</div><div class="heatmap"><div class="heatmap-grid" id="heatmapGrid"></div><div class="heatmap-labels"><span>å®è§‚</span><span>åˆ¶è£</span><span>ç®—åŠ›</span><span>é‡‘å±</span><span>ç¢³</span><span>ä¸œå—äºš</span><span>å‰æ²¿</span><span>arXiv</span></div></div><div style="margin-top:16px"><div style="font-size:11px;font-weight:500;margin-bottom:8px">å»é‡ç»Ÿè®¡</div><div id="dedupeStats" style="font-size:11px;color:var(--muted)"></div></div></div>
</div></aside></div>
<nav class="mobile-nav"><button class="mobile-nav-item active" data-show="feed"><span class="mobile-nav-icon">ğŸ“°</span><span class="mobile-nav-label">æ–°é—»</span></button><button class="mobile-nav-item" data-show="left"><span class="mobile-nav-icon">â˜°</span><span class="mobile-nav-label">å¯¼èˆª</span></button><button class="mobile-nav-item" data-show="right-kpi"><span class="mobile-nav-icon">ğŸ“Š</span><span class="mobile-nav-label">æ•°æ®</span></button><button class="mobile-nav-item" data-show="settings"><span class="mobile-nav-icon">âš™ï¸</span><span class="mobile-nav-label">è®¾ç½®</span></button></nav>
<div class="modal" id="settingsModal"><div class="modal-box"><div class="modal-header"><span class="modal-title">è®¾ç½®</span><button class="modal-close" id="closeSettings">Ã—</button></div>
<div class="modal-tabs"><button class="modal-tab active" data-tab="sections">ç±»ç›®ç®¡ç†</button><button class="modal-tab" data-tab="data">æ•°æ®æº</button><button class="modal-tab" data-tab="sync">åŒæ­¥</button></div>
<div class="modal-body">
<div class="tab-pane active" id="pane-sections"><div id="sectionsList"></div><button type="button" class="editor-add" id="addSection">+ æ·»åŠ æ–°ç±»ç›®</button><div class="export-btns"><button class="btn" id="exportSections">å¯¼å‡ºç±»ç›®JSON</button></div></div>
<div class="tab-pane" id="pane-data"><div id="kpisList"></div><button type="button" class="editor-add" id="addKpi">+ æ·»åŠ æ–°æŒ‡æ ‡</button><div class="export-btns"><button class="btn" id="exportKpis">å¯¼å‡ºKPI JSON</button></div></div>
<div class="tab-pane" id="pane-sync"><div class="github-sync"><div class="github-sync-title">ğŸ”„ GitHub é…ç½®åŒæ­¥</div><div class="github-sync-desc">å°†é…ç½®æ›´æ”¹è‡ªåŠ¨åŒæ­¥åˆ°GitHubä»“åº“ï¼ŒT+1ç”Ÿæ•ˆã€‚</div><input type="text" class="github-sync-input" id="githubRepo" placeholder="ç”¨æˆ·å/ä»“åº“å"/><input type="password" class="github-sync-input" id="githubToken" placeholder="GitHub Token (å¯é€‰)"/><button class="github-sync-btn" id="syncToGithub">åŒæ­¥é…ç½®åˆ° GitHub</button><div class="github-sync-status" id="syncStatus" style="display:none"></div></div><div style="margin-top:16px"><div style="font-size:11px;font-weight:500;margin-bottom:8px">æ‰‹åŠ¨å¯¼å‡º/å¯¼å…¥</div><div class="export-btns"><button class="btn" id="exportFullConfig">å¯¼å‡ºå®Œæ•´é…ç½®</button><button class="btn" id="importConfig">å¯¼å…¥é…ç½®</button></div><input type="file" id="importConfigFile" accept=".json" style="display:none"/></div></div>
</div></div></div>
<script>
const D={{DIGEST_JSON}};let sections=D.sections||[],kpis=D.kpis||[],currentSection='top5',currentFilter='all',currentDate=D.date||'',availableDates=[];
let editConfig={sections:JSON.parse(JSON.stringify(sections.map(s=>({id:s.id,name:s.name,gnews_queries:s.gnews_queries||[]})))),kpis:JSON.parse(JSON.stringify(kpis.map(k=>({series:k.series,title:k.title,unit:k.unit}))))};
const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s),esc=s=>String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]||c));
function calculateSentiment(){let t=0,c=0,p=0,ne=0,n=0;sections.forEach(s=>{if(s.sentiment_score!==undefined){t+=s.sentiment_score;c++}if(s.sentiment==='positive')p++;else if(s.sentiment==='negative')ne++;else n++});return{score:c>0?t/c:0.5,positive:p,neutral:n,negative:ne}}
function collectKeywords(){const w={};sections.forEach(s=>(s.keywords||[]).forEach(k=>w[k]=(w[k]||0)+1));return Object.entries(w).sort((a,b)=>b[1]-a[1]).slice(0,20).map(([word,count])=>({word,count}))}
function renderSentimentDashboard(){const s=calculateSentiment();const a=-90+s.score*180;$('#gaugeNeedle').style.transform=`rotate(${a}deg)`;$('#sentimentValue').textContent=s.score.toFixed(2);$('#sentimentPositive').textContent=s.positive;$('#sentimentNeutral').textContent=s.neutral;$('#sentimentNegative').textContent=s.negative}
function renderWordCloud(){const kw=collectKeywords();const mx=Math.max(...kw.map(k=>k.count),1);$('#wordcloud').innerHTML=kw.map(({word,count})=>`<span class="word-item word-size-${Math.min(5,Math.ceil(count/mx*5))}">${esc(word)}</span>`).join('')||'<span style="color:var(--muted);font-size:11px">æš‚æ— å…³é”®è¯</span>'}
function renderHeatmap(){const grid=$('#heatmapGrid');const sids=['macro','sanctions','compute','metals','carbon','sea','frontier','arxiv'];let h='';for(let d=6;d>=0;d--)sids.forEach(sid=>{const sec=sections.find(s=>s.id===sid);const cnt=sec?Math.min(5,Math.floor((sec.raw_count||sec.total_count||0)/5)):0;h+=`<div class="heatmap-cell" data-count="${cnt}"></div>`});grid.innerHTML=h;let tr=0,td=0;sections.forEach(s=>{tr+=s.raw_count||s.total_count||0;td+=s.deduped_count||0});$('#dedupeStats').innerHTML=`åŸå§‹: <strong>${tr}</strong> æ¡ | å»é‡: <strong>${td}</strong> æ¡ | å»é‡ç‡: <strong>${tr>0?((td/tr)*100).toFixed(1):0}%</strong>`}
function renderKpis(){const list=$('#kpiList');if(!kpis.length){list.innerHTML='<div style="text-align:center;color:var(--muted);padding:20px;font-size:12px">æš‚æ— KPIæ•°æ®</div>';return}let h='';kpis.forEach((k,i)=>{const v=k.values||[];const l=v[v.length-1];const p=v[v.length-2];const ch=l&&p?((l-p)/p*100).toFixed(2):null;const cc=ch>0?'up':ch<0?'down':'';const cs=ch!==null?`${ch>0?'+':''}${ch}%`:'';const ma5=v.length>=5?v.slice(-5).reduce((a,b)=>a+b,0)/5:null;const ma20=v.length>=20?v.slice(-20).reduce((a,b)=>a+b,0)/20:null;const rv=v.slice(-20);const su=rv.length>0?Math.min(...rv).toFixed(2):null;const re=rv.length>0?Math.max(...rv).toFixed(2):null;h+=`<div class="kpi-section"><div class="kpi-header"><span class="kpi-title">${esc(k.title)} <span style="color:var(--muted);font-weight:normal">${esc(k.unit||'')}</span></span><div><span class="kpi-value">${l!==undefined?l.toLocaleString():'â€”'}</span>${cs?`<span class="kpi-change ${cc}">${cs}</span>`:''}</div></div><div class="kpi-chart"><canvas id="kc${i}"></canvas></div><div class="kpi-indicators">${ma5?`<span class="kpi-ma"><span class="kpi-ma-dot ma5"></span>MA5:${ma5.toFixed(1)}</span>`:''} ${ma20?`<span class="kpi-ma"><span class="kpi-ma-dot ma20"></span>MA20:${ma20.toFixed(1)}</span>`:''} ${su?`<span class="kpi-support">æ”¯æ’‘:${su}</span>`:''} ${re?`<span class="kpi-resist">é˜»åŠ›:${re}</span>`:''}</div></div>`});list.innerHTML=h;kpis.forEach((k,i)=>{const c=document.getElementById(`kc${i}`);if(c&&k.values?.length>1)drawSparkline(c,k.values)})}
function drawSparkline(canvas,values){const ctx=canvas.getContext('2d');const dpr=window.devicePixelRatio||1;const rect=canvas.getBoundingClientRect();canvas.width=rect.width*dpr;canvas.height=rect.height*dpr;ctx.scale(dpr,dpr);const w=rect.width,h=rect.height,pad=2;const min=Math.min(...values),max=Math.max(...values),range=max-min||1;const toX=i=>pad+(i/(values.length-1))*(w-pad*2);const toY=v=>h-pad-((v-min)/range)*(h-pad*2);if(values.length>=20){ctx.beginPath();ctx.strokeStyle='rgba(175,82,222,0.4)';ctx.lineWidth=1;for(let i=19;i<values.length;i++){const ma=values.slice(i-19,i+1).reduce((a,b)=>a+b,0)/20;if(i===19)ctx.moveTo(toX(i),toY(ma));else ctx.lineTo(toX(i),toY(ma))}ctx.stroke()}if(values.length>=5){ctx.beginPath();ctx.strokeStyle='rgba(255,149,0,0.5)';ctx.lineWidth=1;for(let i=4;i<values.length;i++){const ma=values.slice(i-4,i+1).reduce((a,b)=>a+b,0)/5;if(i===4)ctx.moveTo(toX(i),toY(ma));else ctx.lineTo(toX(i),toY(ma))}ctx.stroke()}ctx.beginPath();ctx.strokeStyle='#0071e3';ctx.lineWidth=1.5;values.forEach((v,i)=>{if(i===0)ctx.moveTo(toX(i),toY(v));else ctx.lineTo(toX(i),toY(v))});ctx.stroke();ctx.beginPath();ctx.fillStyle='#0071e3';ctx.arc(toX(values.length-1),toY(values[values.length-1]),3,0,Math.PI*2);ctx.fill()}
function getIcon(id){return{macro:'ğŸ“ˆ',sanctions:'âš–ï¸',compute:'ğŸ–¥ï¸',metals:'ğŸ”©',carbon:'ğŸŒ±',sea:'ğŸŒ',frontier:'ğŸ”¬',arxiv:'ğŸ“š'}[id]||'ğŸ“„'}
function renderNav(){const nav=$('#navList');let h=`<div class="nav-item ${currentSection==='top5'?'active':''}" data-section="top5"><span class="nav-icon">â­</span><span class="nav-label">ä»Šæ—¥è¦é—»</span><span class="nav-badge">${(D.top5||[]).length}</span></div>`;sections.forEach(sec=>{h+=`<div class="nav-item ${currentSection===sec.id?'active':''}" data-section="${sec.id}"><span class="nav-icon">${getIcon(sec.id)}</span><span class="nav-label">${esc(sec.name)}</span><span class="nav-badge">${sec.total_count||0}</span></div>`});nav.innerHTML=h;nav.querySelectorAll('.nav-item').forEach(item=>{item.onclick=()=>{currentSection=item.dataset.section;renderNav();renderMain();$('#currentSection').textContent=item.querySelector('.nav-label').textContent}})}
function renderMain(){const feed=$('#feed');if(currentSection==='top5'){const top5=D.top5||[];feed.innerHTML=`<div class="section-header"><span class="section-icon">â­</span><span class="section-title">ä»Šæ—¥è¦é—» Top 5</span><span class="section-badge">${top5.length} æ¡</span></div>${top5.map((e,i)=>renderEventCard(e,i+1)).join('')}`;return}const sec=sections.find(s=>s.id===currentSection);if(!sec){feed.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted)">é€‰æ‹©ä¸€ä¸ªæ¿å—æŸ¥çœ‹</div>';return}let events=sec.events||[];if(currentFilter==='cn')events=events.filter(e=>e.region==='cn');else if(currentFilter==='global')events=events.filter(e=>e.region!=='cn');const sc=sec.sentiment==='positive'?'sentiment-positive':sec.sentiment==='negative'?'sentiment-negative':'sentiment-neutral';const st=sec.sentiment==='positive'?'çœ‹å¤š':sec.sentiment==='negative'?'çœ‹ç©º':'ä¸­æ€§';feed.innerHTML=`<div class="section-header"><span class="section-icon">${getIcon(sec.id)}</span><span class="section-title">${esc(sec.name)}</span><span class="section-badge">${events.length} æ¡</span><div class="section-sentiment"><span class="sentiment-dot ${sc}"></span><span>${st} ${((sec.sentiment_score||0.5)*100).toFixed(0)}%</span></div></div><div class="brief"><div class="brief-title">ğŸ“‹ æ¿å—æ‘˜è¦</div><div>${esc(sec.brief_zh||'æš‚æ— æ‘˜è¦')}</div>${sec.keywords?.length?`<div class="keywords-row">${sec.keywords.map(k=>`<span class="keyword-tag">${esc(k)}</span>`).join('')}</div>`:''}</div>${events.map(e=>renderEventCard(e)).join('')}`}
function renderEventCard(event,rank){const sources=event.sources||[];const sc=sources.length;return`<div class="event-card ${event.region==='cn'?'cn':''}"><div class="event-meta">${rank?`<span style="font-weight:600;color:var(--accent)">#${rank}</span>`:''}<span class="event-region ${event.region==='cn'?'cn':''}">${event.region==='cn'?'ğŸ‡¨ğŸ‡³ ä¸­å›½':'ğŸŒ å…¨çƒ'}</span>${event.date?`<span class="event-date">${event.date}</span>`:''}<span class="event-score">é‡è¦æ€§ ${((event.score||0.5)*100).toFixed(0)}%</span></div><div class="event-title">${esc(event.title_zh||event.title||'')}</div><div class="event-summary">${esc(event.summary_zh||event.summary||'')}</div>${sources.length>0?`<div class="event-sources">${sources.slice(0,3).map(s=>`<a href="${esc(s.url)}" target="_blank" class="source-chip">${esc(s.source||'æ¥æº')}</a>`).join('')}${sc>3?`<span class="source-chip"><span class="source-count">+${sc-3}</span></span>`:''}</div>`:''}</div>`}
function renderSettings(tab){if(tab==='sections'){$('#sectionsList').innerHTML=editConfig.sections.map((sec,idx)=>`<div class="editor-item"><div class="editor-item-main"><div class="editor-item-title">${esc(sec.name)}</div><div class="editor-item-sub">ID: ${esc(sec.id)} Â· å…³é”®è¯: ${(sec.gnews_queries||[]).length}ä¸ª</div></div><div class="editor-item-actions"><button class="editor-btn" data-action="edit-section" data-idx="${idx}">âœï¸</button><button class="editor-btn danger" data-action="del-section" data-idx="${idx}">ğŸ—‘ï¸</button></div></div>`).join('')}if(tab==='data'){$('#kpisList').innerHTML=editConfig.kpis.map((kpi,idx)=>`<div class="editor-item"><div class="editor-item-main"><div class="editor-item-title">${esc(kpi.title)}</div><div class="editor-item-sub">FRED: ${esc(kpi.series)} Â· å•ä½: ${esc(kpi.unit||'â€”')}</div></div><div class="editor-item-actions"><button class="editor-btn" data-action="edit-kpi" data-idx="${idx}">âœï¸</button><button class="editor-btn danger" data-action="del-kpi" data-idx="${idx}">ğŸ—‘ï¸</button></div></div>`).join('')}}
function showSectionEditor(idx){document.querySelectorAll('.editor-form').forEach(el=>el.remove());const isNew=idx<0;const sec=isNew?{id:'',name:'',gnews_queries:[]}:{...editConfig.sections[idx]};const q=(sec.gnews_queries||[]).join('\n');const h=`<div class="editor-form"><div class="editor-form-row"><div class="editor-form-group"><label class="editor-form-label">ç±»ç›®ID</label><input type="text" class="editor-input" id="secId" value="${esc(sec.id)}" placeholder="ä¾‹å¦‚: metals"></div><div class="editor-form-group"><label class="editor-form-label">æ˜¾ç¤ºåç§°</label><input type="text" class="editor-input" id="secName" value="${esc(sec.name)}" placeholder="ä¾‹å¦‚: å¤§å®—é‡‘å±"></div></div><div class="editor-form-row"><div class="editor-form-group"><label class="editor-form-label">æœç´¢å…³é”®è¯ (æ¯è¡Œä¸€ä¸ª)</label><textarea class="editor-input" id="secQueries" rows="3" style="width:100%">${esc(q)}</textarea></div></div><div class="editor-form-row" style="justify-content:flex-end;gap:8px"><button type="button" class="btn" id="cancelSec">å–æ¶ˆ</button><button type="button" class="btn primary" id="saveSec">${isNew?'æ·»åŠ ':'ä¿å­˜'}</button></div></div>`;const addBtn=$('#addSection');if(isNew&&addBtn)addBtn.insertAdjacentHTML('afterend',h);else $('#sectionsList').insertAdjacentHTML('beforebegin',h);$('#cancelSec').onclick=()=>document.querySelector('.editor-form').remove();$('#saveSec').onclick=()=>{const ns={id:$('#secId').value.trim(),name:$('#secName').value.trim(),gnews_queries:$('#secQueries').value.split('\n').map(s=>s.trim()).filter(Boolean)};if(!ns.id||!ns.name){alert('è¯·å¡«å†™IDå’Œåç§°');return}if(isNew)editConfig.sections.push(ns);else editConfig.sections[idx]=ns;renderSettings('sections')};document.querySelector('.editor-form')?.scrollIntoView({behavior:'smooth',block:'center'})}
function showKpiEditor(idx){document.querySelectorAll('.editor-form').forEach(el=>el.remove());const isNew=idx<0;const kpi=isNew?{series:'',title:'',unit:''}:{...editConfig.kpis[idx]};const h=`<div class="editor-form"><div class="editor-form-row"><div class="editor-form-group"><label class="editor-form-label">FREDç³»åˆ—ID</label><input type="text" class="editor-input" id="kpiSeries" value="${esc(kpi.series)}" placeholder="PCOPPUSDM"></div><div class="editor-form-group"><label class="editor-form-label">æ˜¾ç¤ºåç§°</label><input type="text" class="editor-input" id="kpiTitle" value="${esc(kpi.title)}" placeholder="é“œ"></div><div class="editor-form-group" style="flex:0.5"><label class="editor-form-label">å•ä½</label><input type="text" class="editor-input" id="kpiUnit" value="${esc(kpi.unit)}" placeholder="$/t"></div></div><div class="editor-form-row" style="justify-content:flex-end;gap:8px"><button type="button" class="btn" id="cancelKpi">å–æ¶ˆ</button><button type="button" class="btn primary" id="saveKpi">${isNew?'æ·»åŠ ':'ä¿å­˜'}</button></div></div>`;const addBtn=$('#addKpi');if(isNew&&addBtn)addBtn.insertAdjacentHTML('afterend',h);else $('#kpisList').insertAdjacentHTML('beforebegin',h);$('#cancelKpi').onclick=()=>document.querySelector('.editor-form').remove();$('#saveKpi').onclick=()=>{const nk={series:$('#kpiSeries').value.trim(),title:$('#kpiTitle').value.trim(),unit:$('#kpiUnit').value.trim()};if(!nk.series||!nk.title){alert('è¯·å¡«å†™ç³»åˆ—IDå’Œåç§°');return}if(isNew)editConfig.kpis.push(nk);else editConfig.kpis[idx]=nk;renderSettings('data')};document.querySelector('.editor-form')?.scrollIntoView({behavior:'smooth',block:'center'})}
async function syncToGithub(){const repo=$('#githubRepo').value.trim();const token=$('#githubToken').value.trim();const st=$('#syncStatus');if(!repo){alert('è¯·è¾“å…¥GitHubä»“åº“åœ°å€');return}st.style.display='block';st.className='github-sync-status pending';st.textContent='æ­£åœ¨åŒæ­¥...';const config={sections:editConfig.sections,kpis:editConfig.kpis};try{const gr=await fetch(`https://api.github.com/repos/${repo}/contents/digest_config_v15.json`,{headers:token?{'Authorization':`token ${token}`}:{}});let sha=null;if(gr.ok){const d=await gr.json();sha=d.sha}const content=btoa(unescape(encodeURIComponent(JSON.stringify(config,null,2))));const pr=await fetch(`https://api.github.com/repos/${repo}/contents/digest_config_v15.json`,{method:'PUT',headers:{'Authorization':`token ${token}`,'Content-Type':'application/json'},body:JSON.stringify({message:`chore: update config (${new Date().toISOString().slice(0,10)})`,content:content,sha:sha})});if(pr.ok){st.className='github-sync-status success';st.textContent='âœ… åŒæ­¥æˆåŠŸï¼é…ç½®å°†åœ¨ä¸‹æ¬¡ç”Ÿæˆæ—¶ç”Ÿæ•ˆï¼ˆT+1ï¼‰'}else{const err=await pr.json();throw new Error(err.message||'åŒæ­¥å¤±è´¥')}}catch(e){st.className='github-sync-status error';st.textContent='âŒ åŒæ­¥å¤±è´¥: '+e.message}}
function exportFullConfig(){const config={sections:editConfig.sections,kpis:editConfig.kpis};const blob=new Blob([JSON.stringify(config,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`digest_config_${new Date().toISOString().slice(0,10)}.json`;a.click();URL.revokeObjectURL(url)}
function importConfig(file){const reader=new FileReader();reader.onload=e=>{try{const c=JSON.parse(e.target.result);if(c.sections)editConfig.sections=c.sections;if(c.kpis)editConfig.kpis=c.kpis;renderSettings('sections');renderSettings('data');alert('é…ç½®å¯¼å…¥æˆåŠŸï¼')}catch(err){alert('é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯: '+err.message)}};reader.readAsText(file)}
async function loadHistoryDigest(date){try{const r=await fetch(`archive/digest_${date}.json`);if(!r.ok)throw new Error('Not found');const d=await r.json();sections=d.sections||[];kpis=d.kpis||[];currentDate=d.date||date;renderAll();$('#dateDropdown').classList.remove('show')}catch(e){alert('æ— æ³•åŠ è½½å†å²æ•°æ®: '+e.message)}}
async function loadAvailableDates(){try{const r=await fetch('archive/index.json');if(r.ok){const d=await r.json();availableDates=d.dates||[];renderDatePicker()}}catch(e){}}
function renderDatePicker(){const list=$('#dateList');if(!availableDates.length){list.innerHTML='<div class="date-dropdown-item" style="color:var(--muted)">æš‚æ— å†å²æ•°æ®</div>';return}list.innerHTML=availableDates.map(date=>`<div class="date-dropdown-item ${date===currentDate?'active':''}" data-date="${date}">${date}</div>`).join('');list.querySelectorAll('.date-dropdown-item').forEach(item=>{if(item.dataset.date)item.onclick=()=>loadHistoryDigest(item.dataset.date)})}
function renderAll(){renderNav();renderMain();renderKpis();renderSentimentDashboard();renderWordCloud();renderHeatmap();$('#pageDate').textContent=currentDate||'â€”'}
function bindEvents(){$('#themeBtn').onclick=()=>{const d=document.documentElement.getAttribute('data-theme')==='dark';document.documentElement.setAttribute('data-theme',d?'':'dark');localStorage.setItem('theme',d?'':'dark')};$('#datePickerBtn').onclick=e=>{e.stopPropagation();$('#dateDropdown').classList.toggle('show')};document.addEventListener('click',()=>$('#dateDropdown').classList.remove('show'));$('#settingsBtn').onclick=()=>{$('#settingsModal').classList.add('show');renderSettings('sections');renderSettings('data')};$('#closeSettings').onclick=()=>$('#settingsModal').classList.remove('show');$('#settingsModal').onclick=e=>{if(e.target===$('#settingsModal'))$('#settingsModal').classList.remove('show')};$$('.modal-tab').forEach(tab=>{tab.onclick=()=>{$$('.modal-tab').forEach(t=>t.classList.remove('active'));$$('.tab-pane').forEach(p=>p.classList.remove('active'));tab.classList.add('active');$(`#pane-${tab.dataset.tab}`).classList.add('active');renderSettings(tab.dataset.tab)}});$$('.right-tab').forEach(tab=>{tab.onclick=()=>{$$('.right-tab').forEach(t=>t.classList.remove('active'));$$('.panel-content').forEach(p=>p.style.display='none');tab.classList.add('active');$(`#panel-${tab.dataset.panel}`).style.display='block'}});$$('.pill[data-filter]').forEach(pill=>{pill.onclick=()=>{$$('.pill[data-filter]').forEach(p=>p.classList.remove('active'));pill.classList.add('active');currentFilter=pill.dataset.filter;renderMain()}});$('#searchInput').oninput=e=>{const q=e.target.value.toLowerCase();$$('.event-card').forEach(card=>{card.style.display=card.textContent.toLowerCase().includes(q)?'':'none'})};$$('.mobile-nav-item').forEach(item=>{item.onclick=()=>{$$('.mobile-nav-item').forEach(i=>i.classList.remove('active'));item.classList.add('active');$('.left').classList.remove('mobile-show');$('.right').classList.remove('mobile-show');const show=item.dataset.show;if(show==='left')$('.left').classList.add('mobile-show');else if(show==='right-kpi')$('.right').classList.add('mobile-show');else if(show==='settings')$('#settingsModal').classList.add('show')}});document.body.onclick=e=>{const t=e.target.closest('button');if(!t)return;const a=t.dataset.action;const idx=parseInt(t.dataset.idx);if(a==='edit-section')showSectionEditor(idx);else if(a==='del-section'){if(confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')){editConfig.sections.splice(idx,1);renderSettings('sections')}}else if(a==='edit-kpi')showKpiEditor(idx);else if(a==='del-kpi'){if(confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')){editConfig.kpis.splice(idx,1);renderSettings('data')}}else if(t.id==='addSection')showSectionEditor(-1);else if(t.id==='addKpi')showKpiEditor(-1);else if(t.id==='exportSections'){const b=new Blob([JSON.stringify(editConfig.sections,null,2)],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download='sections.json';a.click();URL.revokeObjectURL(u)}else if(t.id==='exportKpis'){const b=new Blob([JSON.stringify(editConfig.kpis,null,2)],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download='kpis.json';a.click();URL.revokeObjectURL(u)}else if(t.id==='syncToGithub')syncToGithub();else if(t.id==='exportFullConfig')exportFullConfig();else if(t.id==='importConfig')$('#importConfigFile').click()};$('#importConfigFile').onchange=e=>{if(e.target.files[0])importConfig(e.target.files[0])}}
document.addEventListener('DOMContentLoaded',()=>{const st=localStorage.getItem('theme');if(st)document.documentElement.setAttribute('data-theme',st);renderAll();bindEvents();loadAvailableDates()});
</script>
</body></html>
