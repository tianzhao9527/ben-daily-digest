<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>{{ TITLE }} Â· {{ DATE }}</title>
  <style>
    :root{
      --bg:#f5f5f7;
      --panel:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --blue:#0a84ff;
      --good:#34c759;
      --bad:#ff3b30;
      --warn:#ff9f0a;
      --shadow:0 8px 30px rgba(0,0,0,.06);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, "PingFang SC", "Hiragino Sans GB", "Noto Sans CJK SC", "Microsoft YaHei", sans-serif;
    }
    [data-theme="dark"]{
      --bg:#0b0b0f;
      --panel:#14161a;
      --text:#f3f4f6;
      --muted:#9ca3af;
      --line:#2a2f37;
      --shadow:0 14px 40px rgba(0,0,0,.42);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:var(--sans);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    a{color:var(--blue); text-decoration:none}
    a:hover{text-decoration:underline}
    .app{
      max-width: 1600px;
      margin: 0 auto;
      padding: 18px;
      display:grid;
      grid-template-columns: 320px 1fr 360px;
      gap: 18px;
      align-items:start;
    }
    .panel{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .left{ position:sticky; top:18px; height: calc(100vh - 36px); overflow:auto; padding:16px}
    .mid{ padding: 0; overflow:hidden}
    .right{ position:sticky; top:18px; height: calc(100vh - 36px); overflow:auto; padding:16px}
    .title{
      font-size:20px; font-weight:800; letter-spacing:-.02em; margin:0 0 6px 0;
    }
    .meta{
      color:var(--muted); font-size:12px; line-height:1.4;
    }
    .search{
      margin:14px 0 10px 0;
      display:flex; gap:8px;
    }
    .search input{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      background:transparent;
      color:var(--text);
      outline:none;
    }
    .toggle{
      display:flex; gap:8px; flex-wrap:wrap;
      margin:10px 0 14px 0;
    }
    .chip{
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--text);
      cursor:pointer;
      user-select:none;
      background:transparent;
    }
    .chip.active{
      border-color: rgba(10,132,255,.35);
      background: rgba(10,132,255,.14);
      color: var(--text);
    }
    .nav{
      margin-top:10px;
      display:flex; flex-direction:column; gap:8px;
    }
    .nav a{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      color:var(--text);
      font-size:13px;
    }
    .nav a.active{ border-color: rgba(10,132,255,.35); background: rgba(10,132,255,.10); }
    .badge{
      min-width:28px;
      text-align:center;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
    }

    /* mid */
    .midHeader{
      padding:18px 18px 10px 18px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(10,132,255,.06), rgba(0,0,0,0));
    }
    .midHeader h2{ margin:0; font-size:18px; font-weight:800; }
    .midHeader .tools{ display:flex; gap:8px; align-items:center; }
    .btn{
      border:1px solid var(--line);
      border-radius: 12px;
      padding:8px 10px;
      background: transparent;
      color: var(--text);
      cursor:pointer;
      font-size:12px;
    }
    .btn.primary{
      border-color: rgba(10,132,255,.35);
      background: rgba(10,132,255,.14);
    }
    .content{
      padding:18px;
    }
    .section{
      margin-bottom:18px;
      padding-bottom:18px;
      border-bottom:1px solid var(--line);
    }
    .section:last-child{ border-bottom:none; }
    .sectionHeader{
      display:flex; align-items:baseline; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .sectionHeader h3{
      margin:0; font-size:15px; font-weight:800;
    }
    .sectionHeader .small{ color:var(--muted); font-size:12px; }
    .briefGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin:10px 0 14px 0;
    }
    .briefCard{
      border:1px solid var(--line);
      border-radius: 16px;
      padding:12px 12px;
      background: rgba(0,0,0,0);
    }
    .briefCard h4{
      margin:0 0 8px 0;
      font-size:12px; color:var(--muted); font-weight:700;
      text-transform: none;
    }
    .briefCard .big{
      font-weight:900;
      font-size:14px;
      margin-bottom:8px;
      letter-spacing:-.01em;
    }
    .briefCard ul{
      margin:0;
      padding-left:18px;
      color:var(--text);
      font-size:12px;
      line-height:1.55;
    }
    .para{
      margin:10px 0 0 0;
      color:var(--text);
      font-size:13px;
      line-height:1.7;
      white-space: pre-wrap;
    }

    .cards{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .event{
      border:1px solid var(--line);
      border-radius: 16px;
      padding:12px;
      background: rgba(255,255,255,0);
    }
    [data-theme="dark"] .event{ background: rgba(0,0,0,0); }
    .event .head{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .event .head .h{
      font-weight:900; font-size:14px; line-height:1.35; margin:0;
    }
    .event .head .k{
      color:var(--muted); font-size:12px;
      white-space:nowrap;
    }
    .event .conclusion{
      font-size:13px; line-height:1.55; color:var(--text);
      margin:0 0 8px 0;
      white-space: pre-wrap;
    }
    .pillRow{ display:flex; gap:6px; flex-wrap:wrap; margin:8px 0 0 0; }
    .pill{
      border:1px solid var(--line);
      padding:4px 8px;
      border-radius:999px;
      color:var(--muted);
      font-size:11px;
    }
    .sub{
      margin-top:8px;
      border-top:1px dashed var(--line);
      padding-top:8px;
      display:none;
    }
    .event.open .sub{ display:block; }
    .sub h5{ margin:0 0 6px 0; font-size:12px; color:var(--muted); }
    .sub ul{ margin:0; padding-left:18px; font-size:12px; line-height:1.55; }
    .sources{ margin-top:8px; font-size:12px; color:var(--muted); }
    .sources a{ color:var(--blue); }
    .actionsRow{ display:flex; gap:8px; margin-top:10px; }
    .iconBtn{
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid var(--line);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      background:transparent;
      color:var(--text);
    }

    /* right: decision panel */
    .right h3{ margin:0 0 10px 0; font-size:15px; font-weight:900;}
    .kpiGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .kpi{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
    }
    .kpi .row{ display:flex; align-items:baseline; justify-content:space-between; gap:8px;}
    .kpi .name{ font-size:12px; color:var(--muted); font-weight:700;}
    .kpi .unit{ font-size:11px; color:var(--muted); border:1px solid var(--line); padding:2px 6px; border-radius:999px;}
    .kpi .val{ font-size:18px; font-weight:900; letter-spacing:-.02em; margin-top:6px;}
    .kpi .delta{ font-size:12px; margin-top:2px; color:var(--muted);}
    .sparkWrap{ margin-top:6px; }
    .spark{ width:100%; height:44px; display:block; }
    .up{ color: var(--good); }
    .down{ color: var(--bad); }
    .flat{ color: var(--muted); }

    .alerts{ margin-top:14px; }
    .alert{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      margin-bottom:10px;
    }
    .alert .sev{
      display:inline-block;
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      margin-right:6px;
    }
    .alert.warn .sev{ color: var(--warn); border-color: rgba(255,159,10,.35); background: rgba(255,159,10,.10); }
    .alert.info .sev{ color: var(--blue); border-color: rgba(10,132,255,.35); background: rgba(10,132,255,.10); }
    .alert .t{ font-weight:800; font-size:12px; margin:0 0 6px 0;}
    .alert .m{ color:var(--text); font-size:12px; line-height:1.55; margin:0;}
    .footerHint{ color:var(--muted); font-size:12px; margin-top:14px; line-height:1.5;}
    .view{ display:none; }
    .view.active{ display:block; }
    @media (max-width: 1200px){
      .app{ grid-template-columns: 320px 1fr; }
      .right{ display:none; }
    }
    @media (max-width: 860px){
      .app{ grid-template-columns: 1fr; }
      .left, .right{ position:static; height:auto; }
      .cards{ grid-template-columns: 1fr; }
      .briefGrid{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div class="app">

  <!-- LEFT -->
  <aside class="panel left">
    <div>
      <h1 class="title">{{ TITLE }}</h1>
      <div class="meta">æ—¥æœŸï¼š{{ DATE }} Â· ç”Ÿæˆï¼š{{ GENERATED_AT }}ï¼ˆåŒ—äº¬ï¼‰</div>
    </div>

    <div class="search">
      <input id="q" placeholder="æœç´¢æ ‡é¢˜ / æ ‡ç­¾ / æ¥æºâ€¦" />
    </div>

    <div class="toggle" role="tablist" aria-label="è§†å›¾åˆ‡æ¢">
      <div class="chip active" data-viewbtn="all">å…¨éƒ¨</div>
      <div class="chip" data-viewbtn="cn">ä¸­å›½ç›¸å…³</div>
      <div class="chip" data-viewbtn="global">å…¨çƒï¼ˆä¸å«ä¸­å›½ï¼‰</div>
      <div class="chip" id="themeBtn" style="margin-left:auto;">æ—¥/å¤œ</div>
    </div>

    <div class="nav" id="nav">
      <!-- injected -->
    </div>

    <div style="margin-top:16px; display:flex; justify-content:space-between; gap:10px;">
      <button class="btn" onclick="window.scrollTo({top:0,behavior:'smooth'})">å›åˆ°é¡¶éƒ¨</button>
      <button class="btn" onclick="openSettings()">è®¾ç½®</button>
    </div>
  </aside>

  <!-- MID -->
  <main class="panel mid">
    <div class="midHeader">
      <h2>ä»Šæ—¥è¦ç‚¹ä¸äº‹ä»¶å¡</h2>
      <div class="tools">
        <button class="btn" onclick="toggleAll(true)">å±•å¼€å…¨éƒ¨</button>
        <button class="btn" onclick="toggleAll(false)">æŠ˜å å…¨éƒ¨</button>
      </div>
    </div>

    <div class="content">

      {% for key, view in VIEWS.items() %}
      <div class="view {% if key=='all' %}active{% endif %}" data-view="{{ key }}">
        <!-- TOP -->
        <section class="section" id="top">
          <div class="sectionHeader">
            <h3>Top ä»Šæ—¥è¦ç‚¹</h3>
            <div class="small">{{ view.sections | length }} æ ç›®</div>
          </div>

          <div class="briefGrid">
            <div class="briefCard">
              <h4>ä¸€å¥è¯ç»“è®º</h4>
              <div class="big">{{ view.top.one_liner }}</div>
              <h4 style="margin-top:10px;">å…³é”®äº‹å®é”šç‚¹</h4>
              <ul>
                {% for x in view.top.facts %}
                <li>{{ x }}</li>
                {% endfor %}
              </ul>
            </div>
            <div class="briefCard">
              <h4>ä»Šæ—¥åŠ¨ä½œ</h4>
              <ul>
                {% for x in view.top.actions %}
                <li>{{ x }}</li>
                {% endfor %}
              </ul>
              <h4 style="margin-top:10px;">å…³æ³¨æŒ‡æ ‡ / é˜ˆå€¼</h4>
              <ul>
                {% for x in view.top.watch %}
                <li>{{ x }}</li>
                {% endfor %}
              </ul>
            </div>
          </div>

          <div class="para">{{ view.top.summary }}</div>
        </section>

        <!-- SECTIONS -->
        {% for s in view.sections %}
        <section class="section" id="sec-{{ s.id }}">
          <div class="sectionHeader">
            <h3>{{ s.name }}</h3>
            <div class="small">{{ (s.cards|length) }} æ¡ï¼ˆäº‹ä»¶å¡ï¼‰</div>
          </div>

          <div class="briefGrid">
            <div class="briefCard">
              <h4>ä¸€å¥è¯ç»“è®º</h4>
              <div class="big">{{ s.brief.one_liner }}</div>
              <h4 style="margin-top:10px;">äº‹å®é”šç‚¹</h4>
              <ul>
                {% for x in s.brief.facts %}
                <li>{{ x }}</li>
                {% endfor %}
              </ul>
              <h4 style="margin-top:10px;">å½±å“</h4>
              <ul>
                {% for x in s.brief.impacts %}
                <li>{{ x }}</li>
                {% endfor %}
              </ul>
            </div>
            <div class="briefCard">
              <h4>å¯æ‰§è¡ŒåŠ¨ä½œ</h4>
              <ul>
                {% for x in s.brief.actions %}
                <li>{{ x }}</li>
                {% endfor %}
              </ul>
              <h4 style="margin-top:10px;">ç›‘æ§æŒ‡æ ‡ / é˜ˆå€¼</h4>
              <ul>
                {% for x in s.brief.watch %}
                <li>{{ x }}</li>
                {% endfor %}
              </ul>
            </div>
          </div>

          <div class="para">{{ s.brief.summary }}</div>

          <div class="cards">
            {% for c in s.cards %}
            <article class="event" data-event-id="{{ c.id }}" data-region="{{ c.region }}" data-text="{{ (c.headline_zh ~ ' ' ~ (c.tags|join(' ')) ~ ' ' ~ (c.sources[0].name if c.sources) )|e }}">
              <div class="head">
                <p class="h">{{ c.headline_zh }}</p>
                <div class="k">{{ (c.sources[0].name if c.sources) }}</div>
              </div>
              <p class="conclusion">{{ c.conclusion }}</p>

              <div class="pillRow">
                {% for t in c.tags %}
                  <span class="pill">{{ t }}</span>
                {% endfor %}
              </div>

              <div class="actionsRow">
                <button class="btn primary" onclick="toggleEvent(this)">å±•å¼€</button>
                <a class="btn" href="{{ c.sources[0].url if c.sources else '#' }}" target="_blank" rel="noopener">æ‰“å¼€åŸæ–‡</a>
                <div style="flex:1"></div>
                <button class="iconBtn" title="æœ‰ç”¨" onclick="vote(this,'up')">ğŸ‘</button>
                <button class="iconBtn" title="æ— ç”¨" onclick="vote(this,'down')">ğŸ‘</button>
              </div>

              <div class="sub">
                <h5>è¯æ®</h5>
                <ul>
                  {% for x in c.evidence %}
                  <li>{{ x }}</li>
                  {% endfor %}
                </ul>

                <h5 style="margin-top:10px;">å½±å“</h5>
                <ul>
                  {% for x in c.impact %}
                  <li>{{ x }}</li>
                  {% endfor %}
                </ul>

                <h5 style="margin-top:10px;">ä¸‹ä¸€æ­¥</h5>
                <ul>
                  {% for x in c.next %}
                  <li>{{ x }}</li>
                  {% endfor %}
                </ul>

                <div class="sources">
                  æ¥æºï¼š
                  {% for s2 in c.sources %}
                    <a href="{{ s2.url }}" target="_blank" rel="noopener">{{ s2.name }}</a>{% if not loop.last %} Â· {% endif %}
                  {% endfor %}
                </div>
              </div>
            </article>
            {% endfor %}
          </div>
        </section>
        {% endfor %}
      </div>
      {% endfor %}

    </div>
  </main>

  <!-- RIGHT -->
  <aside class="panel right">
    <h3>å†³ç­–é¢æ¿</h3>
    <div class="meta">å¿«ç…§ç”Ÿæˆï¼š{{ GENERATED_AT }}ï¼ˆåŒ—äº¬ï¼‰</div>

    <div class="alerts">
      <h3 style="margin-top:14px;">æç¤º / é˜ˆå€¼è§¦å‘</h3>
      {% if ALERTS and (ALERTS|length)>0 %}
        {% for a in ALERTS %}
        <div class="alert {{ a.severity }}">
          <span class="sev">{{ a.severity }}</span>
          <p class="t">{{ a.title }}ï¼š{{ a.op }}{{ a.threshold }}</p>
          <p class="m">{{ a.message }}</p>
        </div>
        {% endfor %}
      {% else %}
        <div class="meta">ä»Šæ—¥æ— è§¦å‘ã€‚</div>
      {% endif %}
    </div>

    <h3 style="margin-top:14px;">KPI ä¸è¶‹åŠ¿å¿«ç…§</h3>
    <div class="kpiGrid">
      {% for k in KPIS %}
      <div class="kpi">
        <div class="row">
          <div class="name">{{ k.title }} ({{ k.id }})</div>
          <div class="unit">{{ k.unit if k.unit else ' ' }}</div>
        </div>
        <div class="val">{{ 'â€”' if k.value is none else ('%.4g'|format(k.value)) }}</div>
        <div class="delta">
          {% if k.delta_pct is not none %}
            {% if k.direction=='up' %}<span class="up">{% elif k.direction=='down' %}<span class="down">{% else %}<span class="flat">{% endif %}
              {{ '%.2f'|format(k.delta_abs) }} ({{ '%.2f'|format(k.delta_pct) }}%)
            </span>
          {% else %}
            â€”
          {% endif %}
          Â· {{ k.source }}
        </div>
        <div class="sparkWrap {% if k.direction=='up' %}up{% elif k.direction=='down' %}down{% else %}flat{% endif %}">
          {{ k.spark | safe }}
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="footerHint">
      åé¦ˆï¼šåœ¨äº‹ä»¶å¡ç‚¹ ğŸ‘/ğŸ‘ï¼Œä¼šä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼ˆLocalStorageï¼‰ï¼Œç”¨äºåç»­æƒé‡ä¸æ ç›®ä¼˜å…ˆçº§æ ¡å‡†ï¼ˆåç»­è¿­ä»£ï¼‰ã€‚
    </div>
  </aside>

</div>

<!-- Settings modal (simple placeholder) -->
<div id="settings" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); padding:24px;">
  <div class="panel" style="max-width:760px;margin:0 auto;padding:18px;">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:900;font-size:18px;">è®¾ç½®</div>
      <button class="btn" onclick="closeSettings()">å…³é—­</button>
    </div>
    <div style="margin-top:12px;color:var(--muted);font-size:13px;line-height:1.6;">
      æœ¬ç‰ˆæœ¬ä¸ºâ€œå•é¡µé™æ€è¾“å‡ºâ€ã€‚æ ç›®ä¸æ•°æ®ç»´åº¦å»ºè®®é€šè¿‡ <span style="font-family:var(--mono)">digest_config_v15.json</span> å¢åŠ /ä¿®æ”¹ã€‚
      ä¸‹ä¸€é˜¶æ®µå¯åŠ å…¥â€œå¯è§†åŒ–è®¾ç½®ç¼–è¾‘å™¨â€ï¼ˆåœ¨é¡µé¢é‡Œå¡«å†™åç”Ÿæˆ JSON å¹¶ä¸‹è½½ï¼‰ï¼Œå†ç”± GitHub Actions è‡ªåŠ¨åº”ç”¨ã€‚
    </div>
  </div>
</div>

<script>
  const VIEWS = {{ VIEWS | tojson }};
  let currentView = 'all';

  function renderNav(){
    const nav = document.getElementById('nav');
    nav.innerHTML = '';
    const items = [{id:'top', name:'Top ä»Šæ—¥è¦ç‚¹', count: (VIEWS[currentView].sections||[]).length}].concat(VIEWS[currentView].nav||[]);
    items.forEach((it)=>{
      const a = document.createElement('a');
      a.href = it.id==='top' ? '#top' : ('#sec-' + it.id);
      a.dataset.target = it.id;
      a.innerHTML = `<span>${it.name}</span><span class="badge">${it.count}</span>`;
      a.addEventListener('click', ()=>{
        [...nav.querySelectorAll('a')].forEach(x=>x.classList.remove('active'));
        a.classList.add('active');
      });
      nav.appendChild(a);
    });
    // default active
    const first = nav.querySelector('a'); if(first) first.classList.add('active');
  }

  function setView(v){
    currentView = v;
    document.querySelectorAll('.view').forEach(el=>{
      el.classList.toggle('active', el.dataset.view===v);
    });
    document.querySelectorAll('[data-viewbtn]').forEach(btn=>{
      btn.classList.toggle('active', btn.dataset.viewbtn===v);
    });
    renderNav();
    applySearch();
  }

  function toggleEvent(btn){
    const card = btn.closest('.event');
    card.classList.toggle('open');
  }

  function toggleAll(open){
    document.querySelectorAll(`.view[data-view="${currentView}"] .event`).forEach(el=>{
      el.classList.toggle('open', open);
    });
  }

  function vote(btn, dir){
    const card = btn.closest('.event');
    const id = card.dataset.eventId;
    const key = 'digest_votes_v18';
    const obj = JSON.parse(localStorage.getItem(key) || '{}');
    obj[id] = dir;
    localStorage.setItem(key, JSON.stringify(obj));
    btn.style.borderColor = 'rgba(10,132,255,.35)';
    btn.style.background = 'rgba(10,132,255,.10)';
  }

  function applySearch(){
    const q = (document.getElementById('q').value || '').trim().toLowerCase();
    const cards = document.querySelectorAll(`.view[data-view="${currentView}"] .event`);
    cards.forEach(el=>{
      const t = (el.dataset.text || '').toLowerCase();
      el.style.display = (!q || t.includes(q)) ? '' : 'none';
    });
  }

  document.getElementById('q').addEventListener('input', applySearch);

  document.querySelectorAll('[data-viewbtn]').forEach(btn=>{
    btn.addEventListener('click', ()=>setView(btn.dataset.viewbtn));
  });

  // Theme toggle
  function loadTheme(){
    const t = localStorage.getItem('digest_theme') || 'light';
    document.documentElement.dataset.theme = t==='dark' ? 'dark' : 'light';
  }
  function toggleTheme(){
    const cur = document.documentElement.dataset.theme || 'light';
    const next = cur==='dark' ? 'light' : 'dark';
    document.documentElement.dataset.theme = next;
    localStorage.setItem('digest_theme', next);
  }
  document.getElementById('themeBtn').addEventListener('click', toggleTheme);
  loadTheme();

  function openSettings(){ document.getElementById('settings').style.display = 'block'; }
  function closeSettings(){ document.getElementById('settings').style.display = 'none'; }
  window.openSettings = openSettings;
  window.closeSettings = closeSettings;
  window.toggleEvent = toggleEvent;
  window.toggleAll = toggleAll;
  window.vote = vote;

  // init
  renderNav();
</script>

</body>
</html>
