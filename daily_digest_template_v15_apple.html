<!doctype html>
<html lang="zh-CN"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>{{TITLE}}</title>
<style>
:root{
  --bg:#f5f5f7;
  --card:#fff;
  --text:#1d1d1f;
  --muted:#86868b;
  --line:rgba(0,0,0,.06);
  --shadow:0 2px 12px rgba(0,0,0,.04);
  --r:14px;
  --accent:#0071e3;
  --chip:rgba(0,0,0,.03);
  --success:#34c759;
  --danger:#ff3b30;
  --font:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display","PingFang SC","Hiragino Sans GB","Microsoft YaHei",system-ui,sans-serif;
}
[data-theme="dark"]{
  --bg:#000;--card:rgba(28,28,30,.92);--text:#f5f5f7;--muted:#98989d;
  --line:rgba(255,255,255,.08);--shadow:0 4px 24px rgba(0,0,0,.3);--chip:rgba(255,255,255,.05);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:var(--font);-webkit-font-smoothing:antialiased}
body{background:var(--bg);color:var(--text);font-size:13px;line-height:1.5}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}

.container{
  max-width:1480px;margin:0 auto;padding:12px;
  display:grid;gap:12px;grid-template-columns:260px minmax(0,1fr) 340px;
  height:100vh;overflow:hidden;
}
.card{
  background:var(--card);border:1px solid var(--line);border-radius:var(--r);
  box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;
}

/* 左侧 */
.left{min-height:0}
.brand{padding:16px 14px;border-bottom:1px solid var(--line)}
.brand-title{font-size:15px;font-weight:600;letter-spacing:-0.2px;color:var(--text)}
.brand-sub{margin-top:4px;font-size:11px;color:var(--muted);line-height:1.4}
.controls{padding:10px 14px;border-bottom:1px solid var(--line)}
.search{
  width:100%;border:1px solid var(--line);background:var(--chip);
  padding:8px 10px;border-radius:8px;outline:none;color:var(--text);
  font-size:12px;font-family:var(--font);
}
.search:focus{border-color:var(--accent)}
.pills{display:flex;gap:6px;margin-top:8px}
.pill{
  font-size:11px;padding:5px 10px;border-radius:16px;
  border:1px solid var(--line);color:var(--muted);background:transparent;
  cursor:pointer;font-family:var(--font);transition:all .15s;
}
.pill:hover{background:var(--chip)}
.pill.active{color:#fff;border-color:var(--accent);background:var(--accent)}
.nav{flex:1;overflow:auto;padding:6px}
.nav-item{
  display:flex;justify-content:space-between;align-items:center;
  padding:8px 10px;border-radius:8px;color:var(--text);
  font-size:12px;font-weight:500;cursor:pointer;transition:background .15s;margin-bottom:1px;
}
.nav-item:hover{background:var(--chip)}
.nav-item.active{background:rgba(0,113,227,.08);color:var(--accent)}
.nav-item .badge{
  font-size:10px;font-weight:600;color:var(--muted);
  background:var(--chip);padding:2px 6px;border-radius:8px;
}
.nav-item.active .badge{background:rgba(0,113,227,.12);color:var(--accent)}
.left-foot{padding:10px 14px;border-top:1px solid var(--line);display:flex;gap:6px}
.btn{
  flex:1;border:1px solid var(--line);background:var(--card);color:var(--text);
  padding:7px 10px;border-radius:7px;font-size:11px;font-family:var(--font);
  cursor:pointer;transition:all .15s;
}
.btn:hover{background:var(--chip);border-color:var(--accent)}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}

/* 中间 */
.main{min-height:0}
.topbar{padding:14px 18px;border-bottom:1px solid var(--line);background:var(--card)}
.topbar-title{font-size:18px;font-weight:600;letter-spacing:-0.3px}
.topbar-meta{margin-top:3px;font-size:11px;color:var(--muted)}
.main-scroll{flex:1;overflow:auto;padding:16px 18px}

/* Top 5 板块 */
.top5-section{
  margin-bottom:24px;padding:20px;
  background:linear-gradient(135deg,rgba(0,113,227,.04),rgba(52,199,89,.03));
  border:1px solid rgba(0,113,227,.1);border-radius:var(--r);
}
.top5-title{font-size:16px;font-weight:700;color:var(--text);margin-bottom:16px;display:flex;align-items:center;gap:8px}
.top5-title::before{content:'';width:4px;height:18px;background:var(--accent);border-radius:2px}
.top5-list{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.top5-item{
  padding:16px;background:var(--card);border:1px solid var(--line);
  border-radius:12px;transition:all .15s;display:flex;flex-direction:column;
}
.top5-item:hover{border-color:var(--accent);box-shadow:0 4px 12px rgba(0,113,227,.08)}
.top5-item-title{font-size:14px;font-weight:600;color:var(--text);margin-bottom:10px;line-height:1.5}
.top5-item-summary{font-size:13px;color:var(--muted);line-height:1.7;margin-bottom:12px;flex:1}
.top5-item-action{
  font-size:12px;color:var(--accent);font-weight:500;
  padding:6px 12px;background:rgba(0,113,227,.06);border-radius:6px;display:inline-block;
}

/* 板块 */
.section{margin-bottom:28px;scroll-margin-top:16px}
.section-header{margin-bottom:12px}
.section-title{font-size:15px;font-weight:600;color:var(--text);display:flex;align-items:center;gap:8px}
.section-count{font-size:11px;color:var(--muted);font-weight:400}
.section-brief{
  margin-top:10px;padding:14px;background:var(--chip);
  border:1px solid var(--line);border-radius:10px;
  font-size:12px;line-height:1.7;color:var(--text);white-space:pre-wrap;
}

/* 卡片网格 - 优化可读性 */
.cards-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.event-card{
  background:var(--card);border:1px solid var(--line);border-radius:12px;
  padding:16px;transition:all .15s;display:flex;flex-direction:column;
}
.event-card:hover{border-color:var(--accent);box-shadow:0 4px 12px rgba(0,113,227,.08)}
.event-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.event-region{
  display:inline-block;font-size:10px;font-weight:600;
  padding:3px 8px;border-radius:4px;
}
.event-region.cn{background:rgba(255,59,48,.08);color:var(--danger)}
.event-region.us{background:rgba(0,113,227,.08);color:var(--accent)}
.event-region.eu{background:rgba(255,149,0,.08);color:#ff9500}
.event-region.asia{background:rgba(52,199,89,.08);color:var(--success)}
.event-region.global{background:var(--chip);color:var(--muted)}
.event-date{font-size:10px;color:var(--muted);font-weight:500}
.event-title{font-size:14px;font-weight:600;line-height:1.5;margin-bottom:8px;color:var(--text)}
.event-summary{font-size:13px;line-height:1.7;color:var(--muted);flex:1;margin-bottom:12px}
.event-sources{font-size:11px;color:var(--muted);border-top:1px solid var(--line);padding-top:10px}
.event-sources a{color:var(--accent);font-weight:500}
.event-footer{
  display:flex;justify-content:space-between;align-items:center;
  margin-top:10px;padding-top:10px;border-top:1px solid var(--line);
}
.event-score{font-size:11px;color:var(--muted);display:flex;align-items:center;gap:4px}
.score-bar{width:40px;height:4px;background:var(--chip);border-radius:2px;overflow:hidden}
.score-fill{height:100%;background:var(--accent);border-radius:2px}
.feedback-btns{display:flex;gap:4px}
.fb-btn{
  width:28px;height:28px;border:1px solid var(--line);background:transparent;
  border-radius:6px;cursor:pointer;font-size:12px;transition:all .15s;color:var(--muted);
}
.fb-btn:hover{background:var(--chip)}
.fb-btn.active.good{background:rgba(52,199,89,.1);border-color:var(--success);color:var(--success)}
.fb-btn.active.bad{background:rgba(255,59,48,.1);border-color:var(--danger);color:var(--danger)}
.empty{padding:32px 16px;text-align:center;color:var(--muted);font-size:13px;background:var(--chip);border-radius:10px}

/* 右侧 - KPI紧凑布局 */
.right{min-height:0}
.right-header{padding:12px;border-bottom:1px solid var(--line)}
.right-title{font-size:13px;font-weight:600}
.right-sub{margin-top:2px;font-size:9px;color:var(--muted)}
.right-scroll{flex:1;overflow:auto;padding:8px}
.kpi-group{margin-bottom:10px}
.kpi-group-title{
  font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;
  letter-spacing:0.4px;padding:5px 4px;border-bottom:1px solid var(--line);margin-bottom:5px;
  display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none;
}
.kpi-group-title:hover{color:var(--text)}
.kpi-group-title::after{content:'▾';font-size:10px;transition:transform .2s}
.kpi-group.collapsed .kpi-group-title::after{transform:rotate(-90deg)}
.kpi-group.collapsed .kpi-grid{display:none}
.kpi-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px}
.kpi-card{background:var(--chip);border:1px solid var(--line);border-radius:6px;padding:8px}
.kpi-name{font-size:9px;color:var(--muted);font-weight:500;display:flex;align-items:center;gap:3px;margin-bottom:3px}
.kpi-dot{width:5px;height:5px;border-radius:50%}
.kpi-dot.up{background:var(--success)}
.kpi-dot.down{background:var(--danger)}
.kpi-dot.flat{background:var(--muted)}
.kpi-value{font-size:14px;font-weight:600;color:var(--text);font-variant-numeric:tabular-nums}
.kpi-unit{font-size:9px;font-weight:400;color:var(--muted);margin-left:1px}
.kpi-delta{font-size:9px;margin-top:2px}
.kpi-delta.up{color:var(--success)}
.kpi-delta.down{color:var(--danger)}
.kpi-delta.flat{color:var(--muted)}
.kpi-spark{width:100%;height:18px;margin-top:4px}
.kpi-spark path{stroke-width:1.2}
.feedback-stats{margin-top:10px;padding:8px;background:var(--chip);border-radius:6px;border:1px solid var(--line)}
.feedback-stats-title{font-size:10px;font-weight:600;margin-bottom:5px}
.feedback-stats-row{display:flex;justify-content:space-between;font-size:9px;color:var(--muted);margin-bottom:2px}
.feedback-actions{display:flex;gap:4px;margin-top:6px}
.feedback-actions .btn{flex:1;font-size:9px;padding:4px 5px}

/* 设置面板 */
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(4px);
  display:none;justify-content:center;align-items:center;z-index:1000;
}
.overlay.show{display:flex}
.settings-panel{
  width:min(560px,90vw);max-height:85vh;background:var(--card);border-radius:var(--r);
  box-shadow:0 16px 48px rgba(0,0,0,.25);display:flex;flex-direction:column;overflow:hidden;
}
.settings-header{
  padding:16px 20px;border-bottom:1px solid var(--line);
  display:flex;justify-content:space-between;align-items:center;
}
.settings-title{font-size:16px;font-weight:600}
.settings-close{
  width:28px;height:28px;border:none;background:var(--chip);border-radius:6px;
  cursor:pointer;font-size:16px;color:var(--muted);
}
.settings-close:hover{background:var(--line);color:var(--text)}
.settings-tabs{display:flex;gap:3px;padding:10px 20px;border-bottom:1px solid var(--line);background:var(--chip)}
.settings-tab{
  padding:6px 12px;border-radius:6px;font-size:12px;font-weight:500;color:var(--muted);
  cursor:pointer;border:none;background:transparent;font-family:var(--font);transition:all .15s;
}
.settings-tab:hover{background:var(--card)}
.settings-tab.active{background:var(--card);color:var(--text);box-shadow:0 1px 4px rgba(0,0,0,.06)}
.settings-body{flex:1;overflow:auto;padding:20px}
.settings-section{margin-bottom:20px}
.settings-section-title{font-size:13px;font-weight:600;margin-bottom:10px;color:var(--text)}
.settings-row{
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 0;border-bottom:1px solid var(--line);
}
.settings-row:last-child{border-bottom:none}
.settings-label{font-size:12px;color:var(--text)}
.settings-label small{display:block;font-size:10px;color:var(--muted);margin-top:1px}
.settings-input{
  width:100px;padding:6px 10px;border:1px solid var(--line);border-radius:6px;
  font-size:12px;font-family:var(--font);background:var(--card);color:var(--text);text-align:right;
}
.settings-input:focus{outline:none;border-color:var(--accent)}
.settings-toggle{
  position:relative;width:40px;height:22px;background:var(--line);
  border-radius:11px;cursor:pointer;transition:background .2s;
}
.settings-toggle.active{background:var(--success)}
.settings-toggle::after{
  content:'';position:absolute;top:2px;left:2px;width:18px;height:18px;
  background:#fff;border-radius:50%;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.15);
}
.settings-toggle.active::after{transform:translateX(18px)}
.config-preview{
  background:var(--chip);border:1px solid var(--line);border-radius:6px;
  padding:12px;font-family:ui-monospace,monospace;font-size:10px;line-height:1.5;
  max-height:240px;overflow:auto;white-space:pre-wrap;word-break:break-all;
}
/* 可视化编辑器样式 */
.editor-item{
  display:flex;align-items:center;gap:8px;padding:10px 12px;
  background:var(--chip);border:1px solid var(--line);border-radius:8px;margin-bottom:6px;
}
.editor-item:hover{border-color:var(--accent)}
.editor-item-main{flex:1;min-width:0}
.editor-item-title{font-size:12px;font-weight:500;color:var(--text)}
.editor-item-sub{font-size:10px;color:var(--muted);margin-top:2px}
.editor-item-actions{display:flex;gap:4px}
.editor-btn{
  width:26px;height:26px;border:1px solid var(--line);background:var(--card);
  border-radius:5px;cursor:pointer;font-size:12px;color:var(--muted);display:flex;align-items:center;justify-content:center;
}
.editor-btn:hover{background:var(--chip);color:var(--text)}
.editor-btn.danger:hover{background:rgba(255,59,48,.1);color:var(--danger);border-color:var(--danger)}
.editor-input{
  flex:1;padding:8px 10px;border:1px solid var(--line);border-radius:6px;
  font-size:12px;font-family:var(--font);background:var(--card);color:var(--text);
}
.editor-input:focus{outline:none;border-color:var(--accent)}
.editor-input.sm{width:80px;flex:none;text-align:center}
.editor-add{
  width:100%;padding:10px;border:2px dashed var(--line);border-radius:8px;
  background:transparent;cursor:pointer;font-size:12px;color:var(--muted);
  display:flex;align-items:center;justify-content:center;gap:6px;transition:all .15s;
}
.editor-add:hover{border-color:var(--accent);color:var(--accent);background:rgba(0,113,227,.03)}
.editor-form{padding:12px;background:var(--chip);border-radius:8px;margin-bottom:10px}
.editor-form-row{display:flex;gap:8px;margin-bottom:8px}
.editor-form-row:last-child{margin-bottom:0}
.editor-form-label{font-size:11px;color:var(--muted);margin-bottom:4px;display:block}
.editor-form-group{flex:1}
.export-btns{display:flex;gap:8px;margin-top:12px}
.export-btns .btn{flex:1}

/* 响应式布局 */
@media (max-width:1200px){
  .container{grid-template-columns:240px 1fr}
  .right{display:none}
}
@media (max-width:900px){
  .container{grid-template-columns:1fr;height:auto}
  .left{display:none}
  .cards-grid{grid-template-columns:1fr}
  .top5-list{grid-template-columns:1fr}
  .topbar{position:sticky;top:0;z-index:100}
}
@media (max-width:600px){
  html{font-size:14px}
  .main{padding:12px}
  .topbar{padding:12px 16px}
  .topbar-title{font-size:16px}
  .section{margin-bottom:20px}
  .section-title{font-size:14px}
  .section-brief{padding:12px;font-size:12px}
  .event-card{padding:14px}
  .event-title{font-size:13px}
  .event-summary{font-size:12px}
  .top5-section{padding:14px}
  .top5-title{font-size:14px}
  .top5-item{padding:12px}
  .top5-item-title{font-size:13px}
  .top5-item-summary{font-size:12px}
  .kpi-grid{grid-template-columns:1fr 1fr}
}
</style>
</head>
<body>

<div class="container">
  <aside class="card left">
    <div class="brand">
      <div class="brand-title">Ben's Daily Brief</div>
      <div class="brand-sub">金属贸易 · 地缘政治 · AI算力 · 市场数据</div>
    </div>
    <div class="controls">
      <input type="text" class="search" id="searchInput" placeholder="搜索新闻..."/>
      <div class="pills">
        <button class="pill active" data-view="all">全部</button>
        <button class="pill" data-view="cn">中国</button>
        <button class="pill" data-view="global">国际</button>
      </div>
    </div>
    <nav class="nav" id="navList"></nav>
    <div class="left-foot">
      <button class="btn" id="btnSettings">设置</button>
      <button class="btn" id="btnTop">返回顶部</button>
    </div>
  </aside>

  <main class="card main">
    <div class="topbar">
      <div class="topbar-title" id="pageTitle">每日简报</div>
      <div class="topbar-meta"><span id="pageDate">{{DATE}}</span> · 更新于 <span id="pageTime">—</span></div>
    </div>
    <div class="main-scroll" id="mainContent"></div>
  </main>

  <aside class="card right">
    <div class="right-header">
      <div class="right-title">关键指标</div>
      <div class="right-sub">数据来源: FRED · 更新于 <span id="kpiTime">—</span></div>
    </div>
    <div class="right-scroll" id="kpiContent"></div>
  </aside>
</div>

<div class="overlay" id="settingsOverlay">
  <div class="settings-panel">
    <div class="settings-header">
      <div class="settings-title">设置</div>
      <button class="settings-close" id="settingsClose">×</button>
    </div>
    <div class="settings-tabs">
      <button class="settings-tab active" data-tab="general">通用</button>
      <button class="settings-tab" data-tab="sections">类目管理</button>
      <button class="settings-tab" data-tab="weights">重要性系数</button>
      <button class="settings-tab" data-tab="algo">算法</button>
      <button class="settings-tab" data-tab="data">数据源</button>
      <button class="settings-tab" data-tab="config">配置</button>
    </div>
    <div class="settings-body" id="settingsBody"></div>
  </div>
</div>

<script>window.DIGEST = {{ DIGEST_JSON | safe }};</script>
<script>
(function(){
  const D = window.DIGEST || {};
  const sections = Array.isArray(D.sections) ? D.sections : [];
  const kpis = Array.isArray(D.kpis) ? D.kpis : [];
  const meta = D.meta || {};
  const top5 = Array.isArray(D.top5) ? D.top5 : [];

  let currentView = 'all';
  let searchQuery = '';
  let activeSection = sections[0]?.id || '';
  let feedbackData = JSON.parse(localStorage.getItem('digest_feedback') || '{}');

  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => document.querySelectorAll(sel);
  const esc = (s) => String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const fmtNum = (x, d=2) => {
    if (x === null || x === undefined || !isFinite(Number(x))) return '—';
    const n = Number(x);
    if (Math.abs(n) >= 1000) return n.toLocaleString('zh-CN', {maximumFractionDigits: d});
    if (Math.abs(n) >= 100) return n.toFixed(1);
    return n.toFixed(d).replace(/\.?0+$/, '');
  };

  function passesView(region) {
    if (currentView === 'all') return true;
    if (currentView === 'cn') return region === 'cn';
    if (currentView === 'global') return region !== 'cn';
    return true;
  }
  
  function passesSearch(text) {
    if (!searchQuery) return true;
    return text.toLowerCase().includes(searchQuery.toLowerCase());
  }

  function renderNav() {
    const nav = $('#navList');
    if (!nav) return;
    nav.innerHTML = sections.map(sec => {
      const events = (sec.events || []).filter(e => passesView(e.region) && passesSearch(e.title_zh + ' ' + e.summary_zh));
      const isActive = sec.id === activeSection;
      return `<div class="nav-item ${isActive ? 'active' : ''}" data-sid="${esc(sec.id)}">
        <span>${esc(sec.name)}</span><span class="badge">${events.length}</span>
      </div>`;
    }).join('');
    $$('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        activeSection = item.dataset.sid;
        renderAll();
        const target = document.querySelector(`[data-section="${activeSection}"]`);
        if (target) target.scrollIntoView({behavior: 'smooth', block: 'start'});
      });
    });
  }

  function renderMain() {
    const main = $('#mainContent');
    if (!main) return;

    // Top 5 Section
    let top5Html = '';
    if (top5.length > 0) {
      top5Html = `
        <div class="top5-section">
          <div class="top5-title">今日决策要点</div>
          <div class="top5-list">
            ${top5.map(item => `
              <div class="top5-item">
                <div class="top5-item-title">${esc(item.title || '')}</div>
                <div class="top5-item-summary">${esc(item.summary || '')}</div>
                ${item.action ? `<span class="top5-item-action">${esc(item.action)}</span>` : ''}
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    const sectionsHtml = sections.map(sec => {
      const events = (sec.events || []).filter(e => passesView(e.region) && passesSearch(e.title_zh + ' ' + e.summary_zh));
      const brief = sec.brief_zh || '';
      const regionLabels = {cn:'中国',us:'美国',eu:'欧洲',asia:'亚洲',global:'全球'};

      const cardsHtml = events.length > 0 ? `
        <div class="cards-grid">
          ${events.map((ev, idx) => {
            const evId = `${sec.id}-${idx}`;
            const fb = feedbackData[evId] || 0;
            const sources = (ev.sources || []).slice(0, 3);
            const evDate = ev.date || (sources[0]?.published_at) || '';
            const scorePercent = Math.round((ev.score || 0.5) * 100);
            return `
              <div class="event-card" data-evid="${evId}">
                <div class="event-header">
                  <span class="event-region ${ev.region || 'global'}">${regionLabels[ev.region] || '全球'}</span>
                  <span class="event-date">${evDate || ''}</span>
                </div>
                <div class="event-title">${esc(ev.title_zh)}</div>
                <div class="event-summary">${esc(ev.summary_zh)}</div>
                <div class="event-sources">
                  ${sources.map(s => `<a href="${esc(s.url)}" target="_blank">${esc(s.source || s.title || '来源')}</a>`).join(' · ')}
                </div>
                <div class="event-footer">
                  <div class="event-score">
                    <span>重要性</span>
                    <div class="score-bar"><div class="score-fill" style="width:${scorePercent}%"></div></div>
                    <span>${scorePercent}%</span>
                  </div>
                  <div class="feedback-btns">
                    <button class="fb-btn ${fb === 1 ? 'active good' : ''}" data-fb="1" data-evid="${evId}">+</button>
                    <button class="fb-btn ${fb === -1 ? 'active bad' : ''}" data-fb="-1" data-evid="${evId}">-</button>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      ` : '<div class="empty">暂无符合条件的内容</div>';

      return `
        <section class="section" data-section="${esc(sec.id)}">
          <div class="section-header">
            <div class="section-title">${esc(sec.name)} <span class="section-count">${events.length} 条</span></div>
          </div>
          ${brief ? `<div class="section-brief">${esc(brief)}</div>` : ''}
          ${cardsHtml}
        </section>
      `;
    }).join('');

    main.innerHTML = top5Html + sectionsHtml || '<div class="empty">没有可显示的内容</div>';

    $$('.fb-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const evId = btn.dataset.evid;
        const val = parseInt(btn.dataset.fb);
        const current = feedbackData[evId] || 0;
        feedbackData[evId] = (current === val) ? 0 : val;
        localStorage.setItem('digest_feedback', JSON.stringify(feedbackData));
        renderMain();
      });
    });
  }

  function renderKpis() {
    const container = $('#kpiContent');
    if (!container) return;

    const stocksKw = ['sp500', 'nasdaq', 'djia', 'dow', 'vix', 'nikkei', '标普', '纳斯达克', '道琼斯', '恐慌', '日经'];
    const fxKw = ['dex', 'usd', 'cny', 'jpy', 'eur', '汇率', '美元指数'];
    const ratesKw = ['dgs', 'fed', 't10y', '美债', '利率', '利差', '基金'];
    const energyKw = ['oil', 'wti', 'brent', 'gas', '原油', '天然气'];
    const metalsKw = ['copper', 'aluminum', 'zinc', 'nickel', 'lead', 'tin', '铜', '铝', '锌', '镍', '铅', '锡'];
    
    const stocks = [], fx = [], rates = [], energy = [], metals = [];
    kpis.forEach(k => {
      const id = (k.id || k.name || '').toLowerCase();
      if (stocksKw.some(kw => id.includes(kw))) stocks.push(k);
      else if (ratesKw.some(kw => id.includes(kw))) rates.push(k);
      else if (fxKw.some(kw => id.includes(kw))) fx.push(k);
      else if (energyKw.some(kw => id.includes(kw))) energy.push(k);
      else if (metalsKw.some(kw => id.includes(kw))) metals.push(k);
      else rates.push(k);
    });

    function kpiCard(k) {
      const name = k.name || k.id || '—';
      const val = fmtNum(k.value, 2);
      const unit = k.unit || '';
      const delta = k.delta;
      const deltaPct = k.delta_pct;
      const direction = k.direction || 'flat';
      const color = k.color || '#8E8E93';
      
      let deltaStr = '';
      if (delta !== null && delta !== undefined && isFinite(delta)) {
        deltaStr = (delta >= 0 ? '+' : '') + fmtNum(delta, 3);
        if (deltaPct !== null && deltaPct !== undefined && isFinite(deltaPct)) {
          deltaStr += ` (${deltaPct >= 0 ? '+' : ''}${deltaPct.toFixed(2)}%)`;
        }
      }

      let sparkHtml = '';
      const series = k.series_values || k.series || [];
      if (series.length >= 2) {
        const w = 100, h = 24, pad = 2;
        const nums = series.map(Number).filter(isFinite);
        if (nums.length >= 2) {
          const min = Math.min(...nums), max = Math.max(...nums);
          const span = (max - min) || 1;
          const pts = nums.map((v, i) => [
            pad + (w - pad * 2) * (i / (nums.length - 1)),
            pad + (h - pad * 2) * (1 - (v - min) / span)
          ]);
          const d = `M ${pts[0][0].toFixed(1)},${pts[0][1].toFixed(1)} ` + pts.slice(1).map(p => `L ${p[0].toFixed(1)},${p[1].toFixed(1)}`).join(' ');
          sparkHtml = `<svg class="kpi-spark" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none"><path d="${d}" fill="none" stroke="${color}" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
        }
      }

      return `
        <div class="kpi-card">
          <div class="kpi-name"><span class="kpi-dot ${direction}"></span><span>${esc(name)}</span></div>
          <div class="kpi-value" style="color:${color}">${val}<span class="kpi-unit">${esc(unit)}</span></div>
          <div class="kpi-delta ${direction}">${deltaStr || '—'}</div>
          ${sparkHtml}
        </div>
      `;
    }

    let html = '';
    if (stocks.length) html += `<div class="kpi-group"><div class="kpi-group-title">股票指数</div><div class="kpi-grid">${stocks.map(kpiCard).join('')}</div></div>`;
    if (rates.length) html += `<div class="kpi-group"><div class="kpi-group-title">利率债券</div><div class="kpi-grid">${rates.map(kpiCard).join('')}</div></div>`;
    if (fx.length) html += `<div class="kpi-group"><div class="kpi-group-title">外汇汇率</div><div class="kpi-grid">${fx.map(kpiCard).join('')}</div></div>`;
    if (energy.length) html += `<div class="kpi-group"><div class="kpi-group-title">能源商品</div><div class="kpi-grid">${energy.map(kpiCard).join('')}</div></div>`;
    if (metals.length) html += `<div class="kpi-group"><div class="kpi-group-title">金属价格</div><div class="kpi-grid">${metals.map(kpiCard).join('')}</div></div>`;

    const fbCount = Object.values(feedbackData).filter(v => v !== 0).length;
    const goodCount = Object.values(feedbackData).filter(v => v === 1).length;
    const badCount = Object.values(feedbackData).filter(v => v === -1).length;
    
    html += `
      <div class="feedback-stats">
        <div class="feedback-stats-title">反馈统计</div>
        <div class="feedback-stats-row"><span>已反馈</span><span>${fbCount}</span></div>
        <div class="feedback-stats-row"><span>有价值</span><span>${goodCount}</span></div>
        <div class="feedback-stats-row"><span>无关</span><span>${badCount}</span></div>
        <div class="feedback-actions">
          <button class="btn" id="btnExportFb">导出</button>
          <button class="btn" id="btnClearFb">清空</button>
        </div>
      </div>
    `;

    container.innerHTML = html;

    // KPI分组折叠
    $$('.kpi-group-title').forEach(title => {
      title.addEventListener('click', () => {
        title.parentElement.classList.toggle('collapsed');
      });
    });

    $('#btnExportFb')?.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(feedbackData, null, 2)], {type: 'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `feedback_${D.date || 'export'}.json`;
      a.click();
    });
    
    $('#btnClearFb')?.addEventListener('click', () => {
      if (confirm('确定清空所有反馈？')) {
        feedbackData = {};
        localStorage.removeItem('digest_feedback');
        renderKpis();
      }
    });
  }

  // 可编辑配置存储
  let editConfig = {
    importance_weights: JSON.parse(JSON.stringify(meta.importance_weights || {})),
    sections: sections.map(s => ({id: s.id, name: s.name, gnews_queries: s.gnews_queries || [], type: s.type || 'gnews'})),
    kpis: kpis.map(k => ({series: k.id || k.series, title: k.name || k.title, unit: k.unit || ''}))
  };

  function renderSettings(tab = 'general') {
    const body = $('#settingsBody');
    if (!body) return;
    const weights = editConfig.importance_weights;

    const tabs = {
      general: `
        <div class="settings-section">
          <div class="settings-section-title">基本信息</div>
          <div class="settings-row"><div class="settings-label">生成日期</div><div>${esc(D.date || '—')}</div></div>
          <div class="settings-row"><div class="settings-label">生成时间</div><div>${esc(D.generated_at_bjt || '—')}</div></div>
          <div class="settings-row"><div class="settings-label">板块数量</div><div>${editConfig.sections.length}</div></div>
          <div class="settings-row"><div class="settings-label">KPI指标数</div><div>${editConfig.kpis.length}</div></div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">主题</div>
          <div class="settings-row"><div class="settings-label">深色模式</div><div class="settings-toggle" id="toggleDark"></div></div>
        </div>
      `,
      sections: `
        <div class="settings-section">
          <div class="settings-section-title">类目管理 (${editConfig.sections.length}个)</div>
          <p style="font-size:11px;color:var(--muted);margin-bottom:12px">可视化编辑类目，完成后导出JSON替换配置文件</p>
          <div id="sectionsList">
            ${editConfig.sections.map((sec, i) => `
              <div class="editor-item" data-idx="${i}">
                <div class="editor-item-main">
                  <div class="editor-item-title">${esc(sec.name)}</div>
                  <div class="editor-item-sub">ID: ${esc(sec.id)} · 关键词: ${(sec.gnews_queries || []).length}个</div>
                </div>
                <div class="editor-item-actions">
                  <button class="editor-btn edit-section" data-idx="${i}" title="编辑">✎</button>
                  <button class="editor-btn danger del-section" data-idx="${i}" title="删除">×</button>
                </div>
              </div>
            `).join('')}
          </div>
          <button class="editor-add" id="addSection">+ 添加新类目</button>
          <div class="export-btns">
            <button class="btn" id="exportSections">导出类目JSON</button>
          </div>
        </div>
      `,
      weights: `
        <div class="settings-section">
          <div class="settings-section-title">重要性系数</div>
          <p style="font-size:11px;color:var(--muted);margin-bottom:12px">调整系数后导出JSON替换配置文件</p>
          <div class="settings-row">
            <div class="settings-label">中国相关新闻<small>china_related</small></div>
            <input type="number" class="settings-input weight-input" data-key="china_related" value="${weights.china_related || 1.5}" step="0.1" min="0.5" max="3">
          </div>
          <div class="settings-row">
            <div class="settings-label">一级来源<small>source_tier1 (Bloomberg, Reuters)</small></div>
            <input type="number" class="settings-input weight-input" data-key="source_tier1" value="${weights.source_tier1 || 1.3}" step="0.1" min="0.5" max="3">
          </div>
          <div class="settings-row">
            <div class="settings-label">二级来源<small>source_tier2 (WSJ, SCMP)</small></div>
            <input type="number" class="settings-input weight-input" data-key="source_tier2" value="${weights.source_tier2 || 1.1}" step="0.1" min="0.5" max="3">
          </div>
          <div class="settings-row">
            <div class="settings-label">24小时内新闻<small>recency_24h</small></div>
            <input type="number" class="settings-input weight-input" data-key="recency_24h" value="${weights.recency_24h || 1.2}" step="0.1" min="0.5" max="3">
          </div>
          <div class="settings-row">
            <div class="settings-label">48小时内新闻<small>recency_48h</small></div>
            <input type="number" class="settings-input weight-input" data-key="recency_48h" value="${weights.recency_48h || 1.0}" step="0.1" min="0.5" max="3">
          </div>
          <div class="export-btns">
            <button class="btn" id="exportWeights">导出权重JSON</button>
          </div>
        </div>
      `,
      algo: `
        <div class="settings-section">
          <div class="settings-section-title">算法参数</div>
          <div class="settings-row"><div class="settings-label">LLM提供商<small>自动fallback</small></div><div>DeepSeek → Qwen → OpenAI</div></div>
          <div class="settings-row"><div class="settings-label">每板块条目数</div><div>${meta.items_per_section || 15}</div></div>
          <div class="settings-row"><div class="settings-label">原始抓取限制</div><div>${meta.limit_raw || 25}</div></div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">API密钥配置</div>
          <p style="font-size:11px;color:var(--muted);line-height:1.8">
            在 GitHub Secrets 中设置：<br>
            <code>DEEPSEEK_API_KEY</code> · <code>QWEN_API_KEY</code> · <code>OPENAI_API_KEY</code>
          </p>
        </div>
      `,
      data: `
        <div class="settings-section">
          <div class="settings-section-title">KPI指标管理 (${editConfig.kpis.length}个)</div>
          <p style="font-size:11px;color:var(--muted);margin-bottom:12px">编辑FRED数据系列，完成后导出JSON</p>
          <div id="kpisList">
            ${editConfig.kpis.map((k, i) => `
              <div class="editor-item" data-idx="${i}">
                <div class="editor-item-main">
                  <div class="editor-item-title">${esc(k.title)}</div>
                  <div class="editor-item-sub">FRED: ${esc(k.series)} ${k.unit ? '· 单位: ' + esc(k.unit) : ''}</div>
                </div>
                <div class="editor-item-actions">
                  <button class="editor-btn edit-kpi" data-idx="${i}" title="编辑">✎</button>
                  <button class="editor-btn danger del-kpi" data-idx="${i}" title="删除">×</button>
                </div>
              </div>
            `).join('')}
          </div>
          <button class="editor-add" id="addKpi">+ 添加新指标</button>
          <div class="export-btns">
            <button class="btn" id="exportKpis">导出KPI JSON</button>
          </div>
        </div>
      `,
      config: `
        <div class="settings-section">
          <div class="settings-section-title">导出完整配置</div>
          <p style="font-size:11px;color:var(--muted);margin-bottom:12px">将编辑后的配置导出为 digest_config_v15.json</p>
          <div class="config-preview" id="configPreview">${JSON.stringify(buildFullConfig(), null, 2)}</div>
          <div class="export-btns">
            <button class="btn" id="btnCopyConfig">复制配置</button>
            <button class="btn" id="btnDownloadConfig">下载配置文件</button>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">导出今日数据</div>
          <button class="btn" id="btnExportDigest" style="width:100%">导出完整新闻数据 JSON</button>
        </div>
      `
    };

    body.innerHTML = tabs[tab] || tabs.general;
    bindSettingsEvents(tab);
  }

  function buildFullConfig() {
    return {
      items_per_section: meta.items_per_section || 15,
      limit_raw: meta.limit_raw || 25,
      importance_weights: editConfig.importance_weights,
      sections: editConfig.sections,
      kpis: editConfig.kpis.map(k => ({series: k.series, title: k.title, unit: k.unit, lookback: 40}))
    };
  }

  function bindSettingsEvents(tab) {
    // 通用事件
    $('#toggleDark')?.addEventListener('click', function() {
      this.classList.toggle('active');
      document.documentElement.setAttribute('data-theme', this.classList.contains('active') ? 'dark' : 'light');
    });

    // 权重编辑
    $$('.weight-input').forEach(input => {
      input.addEventListener('change', (e) => {
        editConfig.importance_weights[e.target.dataset.key] = parseFloat(e.target.value);
      });
    });
    $('#exportWeights')?.addEventListener('click', () => {
      downloadJSON({importance_weights: editConfig.importance_weights}, 'importance_weights.json');
    });

    // 类目编辑
    $$('.edit-section').forEach(btn => {
      btn.addEventListener('click', () => showSectionEditor(parseInt(btn.dataset.idx)));
    });
    $$('.del-section').forEach(btn => {
      btn.addEventListener('click', () => {
        if (confirm('确定删除此类目？')) {
          editConfig.sections.splice(parseInt(btn.dataset.idx), 1);
          renderSettings('sections');
        }
      });
    });
    $('#addSection')?.addEventListener('click', () => showSectionEditor(-1));
    $('#exportSections')?.addEventListener('click', () => {
      downloadJSON({sections: editConfig.sections}, 'sections.json');
    });

    // KPI编辑
    $$('.edit-kpi').forEach(btn => {
      btn.addEventListener('click', () => showKpiEditor(parseInt(btn.dataset.idx)));
    });
    $$('.del-kpi').forEach(btn => {
      btn.addEventListener('click', () => {
        if (confirm('确定删除此指标？')) {
          editConfig.kpis.splice(parseInt(btn.dataset.idx), 1);
          renderSettings('data');
        }
      });
    });
    $('#addKpi')?.addEventListener('click', () => showKpiEditor(-1));
    $('#exportKpis')?.addEventListener('click', () => {
      downloadJSON({kpis: editConfig.kpis.map(k => ({series: k.series, title: k.title, unit: k.unit, lookback: 40}))}, 'kpis.json');
    });

    // 配置导出
    $('#btnCopyConfig')?.addEventListener('click', () => {
      navigator.clipboard.writeText(JSON.stringify(buildFullConfig(), null, 2));
      alert('已复制到剪贴板');
    });
    $('#btnDownloadConfig')?.addEventListener('click', () => {
      downloadJSON(buildFullConfig(), 'digest_config_v15.json');
    });
    $('#btnExportDigest')?.addEventListener('click', () => {
      downloadJSON(D, `digest_${D.date || 'export'}.json`);
    });
  }

  function downloadJSON(data, filename) {
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
  }

  function showSectionEditor(idx) {
    const isNew = idx < 0;
    const sec = isNew ? {id: '', name: '', gnews_queries: []} : {...editConfig.sections[idx]};
    const queries = (sec.gnews_queries || []).join('\n');
    
    const html = `
      <div class="editor-form">
        <div class="editor-form-row">
          <div class="editor-form-group">
            <label class="editor-form-label">类目ID (英文)</label>
            <input type="text" class="editor-input" id="secId" value="${esc(sec.id)}" placeholder="例如: metals">
          </div>
          <div class="editor-form-group">
            <label class="editor-form-label">显示名称</label>
            <input type="text" class="editor-input" id="secName" value="${esc(sec.name)}" placeholder="例如: 大宗金属">
          </div>
        </div>
        <div class="editor-form-row">
          <div class="editor-form-group" style="flex:1">
            <label class="editor-form-label">搜索关键词 (每行一个)</label>
            <textarea class="editor-input" id="secQueries" rows="4" style="width:100%;resize:vertical" placeholder="LME copper price&#10;aluminum market">${esc(queries)}</textarea>
          </div>
        </div>
        <div class="editor-form-row" style="justify-content:flex-end;gap:8px">
          <button class="btn" id="cancelSec">取消</button>
          <button class="btn" id="saveSec" style="background:var(--accent);color:#fff">${isNew ? '添加' : '保存'}</button>
        </div>
      </div>
    `;
    
    const list = $('#sectionsList');
    if (list) {
      list.insertAdjacentHTML('beforebegin', html);
      $('#cancelSec').onclick = () => { document.querySelector('.editor-form').remove(); };
      $('#saveSec').onclick = () => {
        const newSec = {
          id: $('#secId').value.trim(),
          name: $('#secName').value.trim(),
          gnews_queries: $('#secQueries').value.split('\n').map(s => s.trim()).filter(Boolean)
        };
        if (!newSec.id || !newSec.name) { alert('请填写ID和名称'); return; }
        if (isNew) editConfig.sections.push(newSec);
        else editConfig.sections[idx] = newSec;
        renderSettings('sections');
      };
    }
  }

  function showKpiEditor(idx) {
    const isNew = idx < 0;
    const kpi = isNew ? {series: '', title: '', unit: ''} : {...editConfig.kpis[idx]};
    
    const html = `
      <div class="editor-form">
        <div class="editor-form-row">
          <div class="editor-form-group">
            <label class="editor-form-label">FRED系列ID</label>
            <input type="text" class="editor-input" id="kpiSeries" value="${esc(kpi.series)}" placeholder="例如: PCOPPUSDM">
          </div>
          <div class="editor-form-group">
            <label class="editor-form-label">显示名称</label>
            <input type="text" class="editor-input" id="kpiTitle" value="${esc(kpi.title)}" placeholder="例如: 铜">
          </div>
          <div class="editor-form-group" style="flex:0.5">
            <label class="editor-form-label">单位</label>
            <input type="text" class="editor-input" id="kpiUnit" value="${esc(kpi.unit)}" placeholder="$/t">
          </div>
        </div>
        <div class="editor-form-row" style="justify-content:flex-end;gap:8px">
          <button class="btn" id="cancelKpi">取消</button>
          <button class="btn" id="saveKpi" style="background:var(--accent);color:#fff">${isNew ? '添加' : '保存'}</button>
        </div>
      </div>
    `;
    
    const list = $('#kpisList');
    if (list) {
      list.insertAdjacentHTML('beforebegin', html);
      $('#cancelKpi').onclick = () => { document.querySelector('.editor-form').remove(); };
      $('#saveKpi').onclick = () => {
        const newKpi = {
          series: $('#kpiSeries').value.trim(),
          title: $('#kpiTitle').value.trim(),
          unit: $('#kpiUnit').value.trim()
        };
        if (!newKpi.series || !newKpi.title) { alert('请填写系列ID和名称'); return; }
        if (isNew) editConfig.kpis.push(newKpi);
        else editConfig.kpis[idx] = newKpi;
        renderSettings('data');
      };
    }
  }

  function renderAll() {
    renderNav();
    renderMain();
    renderKpis();
    $('#pageDate').textContent = D.date || '—';
    $('#pageTime').textContent = D.generated_at_bjt || '—';
    $('#kpiTime').textContent = D.generated_at_bjt || '—';
  }

  function bindControls() {
    $('#searchInput')?.addEventListener('input', (e) => { searchQuery = e.target.value; renderAll(); });
    $$('.pill').forEach(pill => {
      pill.addEventListener('click', () => {
        $$('.pill').forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
        currentView = pill.dataset.view;
        renderAll();
      });
    });
    $('#btnSettings')?.addEventListener('click', () => { $('#settingsOverlay').classList.add('show'); renderSettings('general'); });
    $('#settingsClose')?.addEventListener('click', () => { $('#settingsOverlay').classList.remove('show'); });
    $('#settingsOverlay')?.addEventListener('click', (e) => { if (e.target === e.currentTarget) $('#settingsOverlay').classList.remove('show'); });
    $$('.settings-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        $$('.settings-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        renderSettings(tab.dataset.tab);
      });
    });
    $('#btnTop')?.addEventListener('click', () => { $('#mainContent')?.scrollTo({top: 0, behavior: 'smooth'}); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') $('#settingsOverlay').classList.remove('show'); });
  }

  bindControls();
  renderAll();
})();
</script>
</body>
</html>
