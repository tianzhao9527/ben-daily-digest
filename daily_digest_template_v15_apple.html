<!doctype html>
<html lang="zh-CN"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Daily Digest Â· {{DATE}}</title>
<style>
:root{--bg:#f5f5f7;--card:#fff;--text:#0b0b0f;--muted:#6e6e73;--line:rgba(0,0,0,.10);--shadow:0 10px 30px rgba(0,0,0,.06);--r:18px;--r2:14px;--accent:#0a84ff;--chip:rgba(0,0,0,.05)}
[data-theme="dark"]{--bg:#0b0b0f;--card:rgba(18,18,24,.94);--text:#f5f5f7;--muted:#a1a1aa;--line:rgba(255,255,255,.12);--shadow:0 14px 44px rgba(0,0,0,.45);--chip:rgba(255,255,255,.08)}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","SF Pro Text","PingFang SC","Hiragino Sans GB","Microsoft YaHei","Noto Sans CJK SC",Arial,sans-serif}
a{color:inherit;text-decoration:none}a:hover{color:var(--accent)}
.container{max-width:1480px;margin:0 auto;padding:18px;display:grid;gap:16px;grid-template-columns:320px minmax(0,1fr) 420px;height:100vh;overflow:hidden}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);min-height:0;overflow:hidden}
.left{display:flex;flex-direction:column}.brand{padding:16px 16px 12px;border-bottom:1px solid var(--line)}
.brand .title{font-size:15px;font-weight:700}.brand .sub{margin-top:6px;font-size:12px;color:var(--muted);line-height:1.45}
.controls{padding:12px 16px;border-bottom:1px solid var(--line)}
.search{width:100%;border:1px solid var(--line);background:transparent;padding:10px 12px;border-radius:12px;outline:none;color:var(--text);font-size:12px}
.pills{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);color:var(--muted);background:transparent;cursor:pointer}
.pill.active{color:var(--text);border-color:rgba(10,132,255,.40);background:rgba(10,132,255,.12)}
.nav{padding:10px 10px 14px;overflow:auto;min-height:0}
.nav a{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-radius:14px;color:var(--text)}
.nav a{font-size:13px;font-weight:600;line-height:1.25}
.nav a .badge{font-weight:600}
.nav a .sub{font-size:11px}

.nav a:hover{background:var(--chip)}.nav a.active{background:rgba(10,132,255,.12);border:1px solid rgba(10,132,255,.20)}
.badge{font-size:12px;color:var(--muted);background:var(--chip);border:1px solid var(--line);padding:3px 8px;border-radius:999px}
.left-foot{margin-top:auto;padding:12px 16px;border-top:1px solid var(--line);display:flex;gap:10px;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px}
.btn{border:1px solid var(--line);background:transparent;color:var(--text);padding:9px 12px;border-radius:12px;font-size:12px;cursor:pointer}
.btn:hover{border-color:rgba(10,132,255,.30)}
.main{display:flex;flex-direction:column}.topbar{padding:16px;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10;background:var(--card)}
.h1{font-size:18px;font-weight:900}.meta{margin-top:6px;font-size:12px;color:var(--muted);line-height:1.45}
.main-scroll{padding:16px;overflow:auto;min-height:0}
.section{scroll-margin-top:90px;margin-bottom:18px}
.section-head{display:flex;align-items:flex-end;justify-content:space-between;gap:10px;margin-bottom:10px}
.section-title{font-size:14px;font-weight:860}.small{font-size:12px;color:var(--muted)}
.brief{border:1px solid var(--line);border-radius:var(--r2);padding:14px;line-height:1.75;font-size:13px}
.actions{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
.tag{font-size:11px;color:var(--muted);border:1px solid var(--line);background:var(--chip);padding:4px 8px;border-radius:999px}
.cards{margin-top:12px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
.event{border:1px solid var(--line);border-radius:var(--r2);padding:12px;transition:.12s ease;display:flex;flex-direction:column;gap:8px}
.event:hover{border-color:rgba(10,132,255,.22);background:rgba(10,132,255,.06)}
.e-title{font-size:13px;font-weight:820;line-height:1.35}
.e-meta{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
.e-sum{font-size:12px;line-height:1.55}
.e-links{margin-top:auto;display:flex;justify-content:space-between;align-items:center;gap:10px}
.link{font-size:12px;color:var(--accent)}
.fb{display:flex;gap:8px}
.iconbtn{border:1px solid var(--line);background:transparent;color:var(--muted);padding:6px 8px;border-radius:10px;cursor:pointer;font-size:12px}
.iconbtn.active.good{border-color:rgba(34,197,94,.45);background:rgba(34,197,94,.12);color:var(--text)}
.iconbtn.active.bad{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.12);color:var(--text)}
.right{display:flex;flex-direction:column}
.right-sticky{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid var(--line);padding:16px}
.right-title{font-size:14px;font-weight:880}.right-sub{margin-top:6px;font-size:12px;color:var(--muted);line-height:1.45}
.right-scroll{padding:14px 16px 16px;overflow:auto;min-height:0}
.kgrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
.kpi{border:1px solid var(--line);border-radius:var(--r2);padding:12px}
.k-head{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;gap:10px}
.k-val{margin-top:6px;font-size:18px;font-weight:900}
.k-delta{margin-top:4px;font-size:12px;color:var(--muted)}
.spark{margin-top:10px;width:100%;height:44px;display:block}
.hr{height:1px;background:var(--line);margin:14px 0}.group{font-size:12px;color:var(--muted);font-weight:800;margin:8px 0}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);opacity:0;pointer-events:none;transition:.18s ease;z-index:999}
.overlay.open{opacity:1;pointer-events:auto}
.panel{position:absolute;right:18px;top:18px;bottom:18px;width:min(520px,calc(100vw - 36px));background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);display:flex;flex-direction:column;overflow:hidden}
.phead{padding:16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
.ptitle{font-size:14px;font-weight:900}
.tabs{padding:10px 16px;border-bottom:1px solid var(--line);display:flex;gap:8px;flex-wrap:wrap}
.tab{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);color:var(--muted);cursor:pointer}
.tab.active{color:var(--text);border-color:rgba(10,132,255,.40);background:rgba(10,132,255,.12)}
.pbody{padding:14px 16px;overflow:auto;min-height:0}
.row{display:flex;justify-content:space-between;gap:14px;align-items:center;margin:10px 0}
.label{font-size:12px;color:var(--muted);line-height:1.4}
.input{width:160px;border:1px solid var(--line);border-radius:12px;padding:9px 10px;background:transparent;color:var(--text);font-size:12px;outline:none}
.note{font-size:12px;color:var(--muted);line-height:1.5;margin-top:10px}
@media (max-width:1200px){.container{grid-template-columns:320px 1fr}.right{display:none}}
@media (max-width:900px){.container{grid-template-columns:1fr;height:auto}.left{display:none}.cards{grid-template-columns:1fr}}

button,input,select,textarea{font-family:var(--font)}

/* --- v15 render fix: essential UI atoms (non-breaking) --- */
.badge{min-width:20px;height:20px;display:inline-flex;align-items:center;justify-content:center;border-radius:999px;background:rgba(148,163,184,.25);font-size:12px;padding:0 6px}
.section{margin-bottom:18px}
.st{font-weight:800;font-size:16px;margin:6px 0}
.sb{opacity:.8;margin:6px 0 10px 0;line-height:1.4}
.card{border:1px solid rgba(148,163,184,.25);border-radius:14px;padding:12px;margin:10px 0;background:rgba(255,255,255,0.02)}
.ct{font-weight:800;margin-bottom:6px}
.cs{opacity:.9;line-height:1.5}
.sources{margin-top:10px;display:flex;flex-direction:column;gap:6px}
.src a{font-weight:650}
.muted{opacity:.65}
.empty{opacity:.65;padding:14px;border:1px dashed rgba(148,163,184,.35);border-radius:14px;margin:12px 0}
.k-name{display:inline-flex;align-items:center;gap:8px}
.dot{width:8px;height:8px;border-radius:999px;display:inline-block}
.spark{width:100%;height:26px;margin-top:8px}
.k-unit{opacity:.7;font-size:12px;margin-left:4px}
/* === v15 PATCH: KPI color rule (red/green) + buttons === */
:root{
  --kpi-up:#16A34A;   /* green */
  --kpi-down:#DC2626; /* red */
  --kpi-flat:#64748B; /* slate */
}
.kpi-dot{ width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:8px; flex:0 0 auto;}
.kpi-dot.up{ background:var(--kpi-up); }
.kpi-dot.down{ background:var(--kpi-down); }
.kpi-dot.flat{ background:var(--kpi-flat); }

.kpi-spark path.up{ stroke:var(--kpi-up) !important; }
.kpi-spark path.down{ stroke:var(--kpi-down) !important; }
.kpi-spark path.flat{ stroke:var(--kpi-flat) !important; }

#settingsModal{
  position:fixed; inset:0; display:none; align-items:center; justify-content:center;
  background:rgba(0,0,0,0.35); z-index:9999;
}
#settingsModal .panel{
  width:min(720px, calc(100vw - 48px));
  max-height:min(80vh, 720px);
  overflow:auto;
  background:#fff; border-radius:16px; padding:18px 18px 14px 18px;
  border:1px solid rgba(148,163,184,0.35);
  box-shadow:0 16px 48px rgba(0,0,0,0.18);
}
#settingsModal .panel h3{ margin:0 0 8px 0; font-size:16px; }
#settingsModal .panel pre{ white-space:pre-wrap; word-break:break-word; overflow:auto;
  margin:10px 0 14px 0; padding:12px; border-radius:12px;
  background:rgba(148,163,184,0.12);
  border:1px solid rgba(148,163,184,0.25);
  font-size:12px; line-height:1.45;
}
#settingsModal .actions{ display:flex; gap:10px; justify-content:flex-end; }

</style></head>
<body>
<div class="container">
  <aside class="card left">
    <div class="brand"><div class="title">Bençš„æ¯æ—¥èµ„è®¯ç®€æŠ¥</div>
      <div class="sub">æ—¥æœŸï¼š{{DATE}} Â· ç”Ÿæˆï¼š<span id="genAt">â€”</span></div>
    </div>
    <div class="controls">
      <input id="q" class="search" placeholder="æœç´¢æ ‡é¢˜/æ ‡ç­¾/æ¥æºâ€¦"/>
      <div class="pills">
        <div class="pill active" data-view="all">å…¨éƒ¨</div>
        <div class="pill" data-view="cn">ä¸­å›½ç›¸å…³</div>
        <div class="pill" data-view="global">å…¨çƒï¼ˆä¸å«ä¸­å›½ï¼‰</div>
      </div>
    </div>
    <nav class="nav" id="nav"></nav>
    <div class="left-foot">
      <button class="btn" id="btnHome">å›åˆ°é¡¶éƒ¨</button>
      <button class="btn" id="btnSettings">è®¾ç½®</button>
    </div>
  </aside>

  <main class="card main">
    <div class="topbar">
      <div class="h1">ä»Šæ—¥è¦ç‚¹ä¸äº‹ä»¶å¡</div>
      <div class="meta">é»˜è®¤ 30 åˆ†é’Ÿæ¨¡å¼ï¼ˆæ¯æ  Top 5ï¼‰ï¼Œå¯åœ¨è®¾ç½®åˆ‡æ¢å…¨é‡ï¼ˆ10â€“20æ¡ï¼‰ã€‚æ‰€æœ‰å†…å®¹å·²é¢„æ¸²æŸ“ï¼Œæ— å®¢æˆ·ç«¯æŠ“å–ã€‚</div>
    </div>
    <div class="main-scroll" id="main"></div>
  </main>

  <aside class="card right">
    <div class="right-sticky">
      <div class="right-title">æ•°æ®ä¸è¶‹åŠ¿å¿«ç…§</div>
      <div class="right-sub">ç”Ÿæˆæ—¶åˆ»å¿«ç…§ï¼ˆå·²å†…åµŒï¼‰<br>æ›´æ–°æ—¶é—´ï¼š<span id="kpiAt">â€”</span></div>
    </div>
    <div class="right-scroll">
      <div class="group">LME é‡‘å±ï¼ˆProxyï¼‰</div><div class="kgrid" id="kMetals"></div>
      <div class="hr"></div>
      <div class="group">åˆ©ç‡ / æ±‡ç‡ / ç¾å…ƒ</div><div class="kgrid" id="kMacro"></div>
      <div class="hr"></div>
      <div class="group">åé¦ˆé—­ç¯</div>
      <div class="kpi">
        <div class="k-head"><span>7 å¤©çª—å£</span><span id="fbCount">0</span></div>
        <div class="k-delta">ç‚¹ ğŸ‘/ğŸ‘ å½¢æˆåå¥½ï¼›å¯å¯¼å‡ºåé¦ˆä¾›ç”Ÿæˆç«¯è¯»å–ï¼ˆç”¨äºâ€œé€‰é¢˜é—­ç¯â€ï¼‰ã€‚</div>
        <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
          <button class="btn" id="btnExport">å¯¼å‡ºåé¦ˆ</button>
          <button class="btn" id="btnClearFB">æ¸…ç©ºæœ¬æœºåé¦ˆ</button>
        </div>
      </div>
    </div>
  </aside>
</div>

<div class="overlay" id="overlay">
  <div class="panel">
    <div class="phead"><div class="ptitle">è®¾ç½®</div><button class="btn" id="btnClose">å…³é—­</button></div>
    <div class="tabs">
      <div class="tab active" data-tab="general">é€šç”¨</div>
      <div class="tab" data-tab="layout">å¸ƒå±€</div>
      <div class="tab" data-tab="algo">ç®—æ³•</div>
      <div class="tab" data-tab="config">æ‰©å±•</div>
    </div>
    <div class="pbody" id="pbody"></div>
  </div>
</div>

<script>window.DIGEST = {{ DIGEST_JSON | safe }};</script>
<script>
(function(){
  const D = (window.DIGEST || {});
  const sections = Array.isArray(D.sections) ? D.sections : [];
  const kpis = Array.isArray(D.kpis) ? D.kpis : [];

  // Top meta
  const dateEl = document.getElementById('date');
  if (dateEl && D.date) dateEl.textContent = D.date;

  const genAtEl = document.getElementById('genAt');
  const kpiAtEl = document.getElementById('kpiAt');
  const genAt = D.generated_at_bjt || D.generated_at_local || D.generated_at_utc || D.generated_at || '';
  if (genAtEl) genAtEl.textContent = genAt || 'â€”';
  if (kpiAtEl) kpiAtEl.textContent = genAt || 'â€”';

  // State
  let view = 'all'; // all | cn | global
  let query = '';
  let activeSectionId = sections[0]?.id || '';

  // Helpers
  const byId = (id) => document.getElementById(id);
  const esc = (s) => String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const fmtNum = (x) => (x === null || x === undefined || Number.isNaN(Number(x))) ? 'â€”' : (Math.abs(Number(x)) >= 100 ? Number(x).toFixed(0) : Number(x).toFixed(3).replace(/0+$/,'').replace(/\.$/,''));
  const isCnView = () => view === 'cn';
  const isGlobalNoCnView = () => view === 'global';

  function pickBrief(sec){
    if (!sec) return '';
    if (isCnView() && sec.brief_cn) return sec.brief_cn;
    if (isGlobalNoCnView() && sec.brief_global) return sec.brief_global;
    return sec.brief_zh || sec.brief_cn || sec.brief_global || '';
  }

  function eventPassesView(ev){
    const r = (ev?.region || 'global');
    if (view === 'all') return true;
    if (view === 'cn') return r === 'cn';
    if (view === 'global') return r !== 'cn';
    return true;
  }

  function eventPassesQuery(ev){
    if (!query) return true;
    const q = query.toLowerCase();
    const hay = [
      ev?.title_zh, ev?.summary_zh,
      ...(Array.isArray(ev?.sources) ? ev.sources.map(s => s?.source || s?.title || '') : [])
    ].join(' ').toLowerCase();
    return hay.includes(q);
  }

  // Render left nav
  function renderNav(){
    const nav = byId('nav');
    if (!nav) return;

    nav.innerHTML = sections.map(sec => {
      const sid = sec.id;
      const name = sec.name || sid;
      const count = Array.isArray(sec.events) ? sec.events.filter(e => eventPassesView(e) && eventPassesQuery(e)).length : 0;
      const active = sid === activeSectionId ? 'active' : '';
      return `<a href="#${esc(sid)}" data-sid="${esc(sid)}" class="${active}">
        <span>${esc(name)}</span><span class="badge">${count}</span>
      </a>`;
    }).join('');

    nav.querySelectorAll('a[data-sid]').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        activeSectionId = a.getAttribute('data-sid') || activeSectionId;
        renderAll();
        const el = document.querySelector(`[data-section="${CSS.escape(activeSectionId)}"]`);
        if (el) el.scrollIntoView({behavior: 'smooth', block: 'start'});
      });
    });
  }

  // Render main content
  function renderMain(){
    const main = byId('main');
    if (!main) return;

    const html = sections.map(sec => {
      const sid = sec.id;
      const title = sec.name || sid;
      const brief = pickBrief(sec);
      const events = Array.isArray(sec.events) ? sec.events.filter(e => eventPassesView(e) && eventPassesQuery(e)) : [];

      const cards = events.map(ev => {
        const sources = Array.isArray(ev.sources) ? ev.sources : [];
        const srcHtml = sources.slice(0, 4).map(s => {
          const u = s.url || '';
          const t = s.title || s.source || 'source';
          const site = s.source || '';
          return `<div class="src"><a href="${esc(u)}" target="_blank" rel="noopener">${esc(t)}</a><span class="muted">${esc(site)}</span></div>`;
        }).join('');

        return `<div class="card">
          <div class="ct">${esc(ev.title_zh || '')}</div>
          <div class="cs">${esc(ev.summary_zh || '')}</div>
          <div class="sources">${srcHtml}</div>
        </div>`;
      }).join('');

      return `<section class="section" data-section="${esc(sid)}">
        <div class="st">${esc(title)}</div>
        ${brief ? `<div class="sb">${esc(brief)}</div>` : ''}
        ${cards || `<div class="empty">æš‚æ— å†…å®¹ï¼ˆå¯èƒ½æ˜¯æ•°æ®æºå½“æ—¥ç¨€ç–æˆ–è¢«è¿‡æ»¤ï¼‰</div>`}
      </section>`;
    }).join('');

    main.innerHTML = html || `<div class="empty">æ²¡æœ‰å¯æ¸²æŸ“çš„å†…å®¹ï¼šDIGEST.sections ä¸ºç©ºã€‚</div>`;
  }

  // Render right panel KPIs
  function renderKpis(){
    const kMetals = byId('kMetals');
    const kMacro = byId('kMacro');
    if (!kMetals || !kMacro) return;

    const metals = [];
    const macro = [];

    for (const k of kpis){
      const id = (k.id || '').toLowerCase();
      // crude routing by id / name
      const bucket = (id.includes('lme') || id.includes('metal') || (k.name||'').includes('é‡‘å±')) ? metals : macro;
      bucket.push(k);
    }

    function kpiCard(k){
      const name = k.name || k.display_name || k.id || 'â€”';
      const unit = k.unit || '';
      const val = (k.value !== undefined) ? fmtNum(k.value) : 'â€”';
      const delta = (k.delta !== undefined && k.delta !== null) ? k.delta : null;
      const color = k.color || '#64748B';
      const deltaTxt = (delta === null) ? '' : (delta >= 0 ? `+${fmtNum(delta)}` : `${fmtNum(delta)}`);
      const spark = k.spark_svg ? k.spark_svg : ''; // if generator provides
      const series = Array.isArray(k.series) ? k.series : null;

      let sparkHtml = '';
      if (spark){
        sparkHtml = `<div class="spark">${spark}</div>`;
      } else if (series && series.length >= 2){
        // ultra-light inline sparkline fallback
        const w=120,h=26,p=2;
        const min=Math.min(...series), max=Math.max(...series), span=(max-min)||1;
        const pts=series.map((v,i)=> {
          const x=p+(w-2*p)*(i/(series.length-1));
          const y=p+(h-2*p)*(1-((v-min)/span));
          return [x,y];
        });
        let d=`M ${pts[0][0].toFixed(2)} ${pts[0][1].toFixed(2)}`;
        for (let i=1;i<pts.length;i++) d += ` L ${pts[i][0].toFixed(2)} ${pts[i][1].toFixed(2)}`;
        sparkHtml = `<svg viewBox="0 0 ${w} ${h}" class="spark"><path d="${d}" fill="none" stroke="${esc(color)}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>`;
      } else {
        sparkHtml = `<div class="muted">â€”</div>`;
      }

      return `<div class="kpi">
        <div class="k-head">
          <span class="dot" style="background:${esc(color)}"></span>
          <span class="k-name">${esc(name)}</span>
          <span class="k-val">${esc(val)}${unit ? `<span class="k-unit">${esc(unit)}</span>`:''}</span>
        </div>
        ${deltaTxt ? `<div class="k-delta">${esc(deltaTxt)}</div>` : `<div class="k-delta muted"> </div>`}
        ${sparkHtml}
      </div>`;
    }

    kMetals.innerHTML = metals.map(kpiCard).join('') || `<div class="muted">æš‚æ—  KPI</div>`;
    kMacro.innerHTML = macro.map(kpiCard).join('') || `<div class="muted">æš‚æ—  KPI</div>`;
  }

  function bindControls(){
    // pills
    document.querySelectorAll('.pill[data-view]').forEach(p => {
      p.addEventListener('click', () => {
        document.querySelectorAll('.pill').forEach(x => x.classList.remove('active'));
        p.classList.add('active');
        view = p.getAttribute('data-view') || 'all';
        renderAll();
      });
    });

    // search
    const q = byId('q');
    if (q){
      q.addEventListener('input', () => {
        query = q.value.trim();
        renderAll();
      });
    }

    // settings overlay open/close
    const overlay = byId('overlay');
    const btnSettings = byId('btnSettings');
    const btnClose = byId('btnClose');
    if (btnSettings && overlay){
      btnSettings.addEventListener('click', () => overlay.classList.add('show'));
    }
    if (btnClose && overlay){
      btnClose.addEventListener('click', () => overlay.classList.remove('show'));
    }
    // home scroll
    const btnHome = byId('btnHome');
    if (btnHome){
      btnHome.addEventListener('click', () => window.scrollTo({top:0, behavior:'smooth'}));
    }
  }

  function renderAll(){
    if (!activeSectionId && sections[0]?.id) activeSectionId = sections[0].id;
    renderNav();
    renderMain();
    renderKpis();

    // feedback count (localStorage)
    try{
      const fb = JSON.parse(localStorage.getItem('digest_fb') || '[]');
      const fbCount = byId('fbCount');
      if (fbCount) fbCount.textContent = String(Array.isArray(fb) ? fb.length : 0);
    }catch(e){}
  }

  // Boot
  bindControls();
  renderAll();
})();
</script>

<script>
/* === v15 PATCH: enforce KPI red/green + wire buttons === */
function _kpiTrendClass(delta){
  const d = Number(delta);
  if (!isFinite(d) || d === 0) return "flat";
  return d > 0 ? "up" : "down";
}
function _formatDelta(delta, deltaPct){
  const d = Number(delta);
  const p = Number(deltaPct);
  let s1 = (isFinite(d) ? (d>0?"+":"") + d.toFixed(3) : "â€”");
  if (isFinite(p)) s1 += " (" + (p>0?"+":"") + (p*100).toFixed(2) + "%)";
  return s1;
}
function _renderSparkSVG(series, cls){
  if (!Array.isArray(series) || series.length < 2) return "";
  const w = 140, h = 34, pad = 3;
  const nums = series.map(v => Number(v)).filter(v => isFinite(v));
  if (nums.length < 2) return "";
  const min = Math.min(...nums), max = Math.max(...nums);
  const span = (max-min) || 1;
  const innerW = w - pad*2, innerH = h - pad*2;
  const pts = nums.map((v,i)=>{
    const x = pad + innerW * (i/(nums.length-1));
    const y = pad + innerH * (1-((v-min)/span));
    return [x,y];
  });
  let d = `M ${pts[0][0].toFixed(2)} ${pts[0][1].toFixed(2)}`;
  for(let i=1;i<pts.length;i++) d += ` L ${pts[i][0].toFixed(2)} ${pts[i][1].toFixed(2)}`;
  return `
    <svg class="kpi-spark" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" aria-hidden="true">
      <path class="${cls}" d="${d}" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
    </svg>
  `;
}

(function(){
  if (!window.DIGEST) return;

  const originalRenderRight = window.renderRightPanel;
  window.renderRightPanel = function(){
    const digest = window.DIGEST || {};
    const container = document.querySelector("#rightPanelKpis");
    if (!container) return originalRenderRight ? originalRenderRight() : undefined;

    const groups = digest.kpi_groups || digest.kpis || [];
    const normGroups = Array.isArray(groups) && groups.length && groups[0] && groups[0].items
      ? groups
      : [{ title: "KPI", items: Array.isArray(groups) ? groups : [] }];

    container.innerHTML = "";
    normGroups.forEach(g=>{
      const sec = document.createElement("div");
      sec.className = "kpi-group";
      sec.innerHTML = `<div class="kpi-group-title">${g.title || ""}</div>`;
      const grid = document.createElement("div");
      grid.className = "kpi-grid";

      (g.items || []).forEach(m=>{
        const delta = (m.delta != null) ? m.delta : (m.change != null ? m.change : 0);
        const deltaPct = (m.delta_pct != null) ? m.delta_pct : (m.change_pct != null ? m.change_pct : null);
        const cls = _kpiTrendClass(delta);
        const val = (m.value != null && isFinite(Number(m.value))) ? Number(m.value) : null;

        const card = document.createElement("div");
        card.className = "kpi-card";

        const name = m.display_name || m.name || m.title || m.key || "KPI";
        const unit = m.unit || "";

        card.innerHTML = `
          <div class="kpi-top">
            <div class="kpi-name">
              <span class="kpi-dot ${cls}"></span>
              <span>${name}</span>
            </div>
            <div class="kpi-value">${val==null ? "â€”" : (Number.isInteger(val) ? val.toString() : val.toFixed(3))} <span class="kpi-unit">${unit}</span></div>
          </div>
          <div class="kpi-sub ${cls}">${_formatDelta(delta, deltaPct)}</div>
          <div class="kpi-spark-wrap">${_renderSparkSVG(m.series || m.trend || m.values || [], cls) || '<div class="kpi-spark-empty">â€”</div>'}</div>
        `;
        grid.appendChild(card);
      });

      sec.appendChild(grid);
      container.appendChild(sec);
    });

    const ts = document.querySelector("#kpiUpdatedAt");
    if (ts) ts.textContent = (digest.generated_at || digest.generatedAt || "â€”");
  };
})();

document.addEventListener("DOMContentLoaded", ()=>{
  const btnTop = document.querySelector("#btnTop");
  if (btnTop){
    btnTop.addEventListener("click", (e)=>{
      e.preventDefault();
      window.scrollTo({top:0, behavior:"smooth"});
      const mid = document.querySelector("#midColumnScroll");
      if (mid) mid.scrollTo({top:0, behavior:"smooth"});
      const left = document.querySelector("#leftColumnScroll");
      if (left) left.scrollTo({top:0, behavior:"smooth"});
      const right = document.querySelector("#rightColumnScroll");
      if (right) right.scrollTo({top:0, behavior:"smooth"});
    });
  }

  const btnSettings = document.querySelector("#btnSettings");
  const modal = document.querySelector("#settingsModal");
  const closeBtn = document.querySelector("#settingsClose");
  const copyBtn = document.querySelector("#settingsCopy");
  const pre = document.querySelector("#settingsPre");

  function openSettings(){
    if (!modal) return;
    if (pre) pre.textContent = JSON.stringify(window.DIGEST?.meta || window.DIGEST || {}, null, 2);
    modal.style.display = "flex";
  }
  function closeSettings(){
    if (!modal) return;
    modal.style.display = "none";
  }

  if (btnSettings) btnSettings.addEventListener("click", (e)=>{ e.preventDefault(); openSettings(); });
  if (closeBtn) closeBtn.addEventListener("click", (e)=>{ e.preventDefault(); closeSettings(); });
  if (modal) modal.addEventListener("click", (e)=>{ if (e.target === modal) closeSettings(); });
  document.addEventListener("keydown", (e)=>{ if (e.key === "Escape") closeSettings(); });

  if (copyBtn){
    copyBtn.addEventListener("click", async (e)=>{
      e.preventDefault();
      try{
        const txt = (pre && pre.textContent) ? pre.textContent : "";
        await navigator.clipboard.writeText(txt);
        copyBtn.textContent = "å·²å¤åˆ¶";
        setTimeout(()=>copyBtn.textContent="å¤åˆ¶é…ç½®", 1200);
      }catch(err){
        copyBtn.textContent = "å¤åˆ¶å¤±è´¥";
        setTimeout(()=>copyBtn.textContent="å¤åˆ¶é…ç½®", 1200);
      }
    });
  }

  if (typeof window.renderRightPanel === "function") {
    try { window.renderRightPanel(); } catch(e) {}
  }
});
</script>
<div id="settingsModal" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" aria-label="Settings">
    <h3>è®¾ç½®</h3>
    <div style="font-size:12px; opacity:0.75;">ç”¨äºå¿«é€Ÿè‡ªæ£€æ¸²æŸ“è¾“å…¥ï¼ˆä¸ä¼šå†™å›é…ç½®ï¼‰ã€‚</div>
    <pre id="settingsPre"></pre>
    <div class="actions">
      <button id="settingsCopy" class="btn">å¤åˆ¶é…ç½®</button>
      <button id="settingsClose" class="btn primary">å…³é—­</button>
    </div>
  </div>
</div>
<script>
/* === v15 PATCH v3: robust buttons (no ID dependency) + safer settings payload === */

function _findClickableByText(txt){
  const candidates = Array.from(document.querySelectorAll("button, a"));
  return candidates.find(el => (el.textContent || "").trim() === txt) || null;
}

function _scrollAllToTop(){
  // Window
  try { window.scrollTo({top:0, behavior:"smooth"}); } catch(e){ window.scrollTo(0,0); }

  // Scrollable containers (limited but robust)
  const nodes = Array.from(document.querySelectorAll("div, main, section, aside"));
  for (const el of nodes){
    const cs = getComputedStyle(el);
    const oy = cs.overflowY;
    if ((oy === "auto" || oy === "scroll") && el.scrollHeight > el.clientHeight + 4){
      try { el.scrollTo({top:0, behavior:"smooth"}); } catch(e){ el.scrollTop = 0; }
    }
  }
}

function _openSettingsModal(){
  const modal = document.getElementById("settingsModal");
  const pre = document.getElementById("settingsPre");
  if (!modal) return;

  const d = window.DIGEST || {};
  // Show meta + KPI summary only (avoid massive payload)
  const payload = {
    date: d.date || d.meta?.date,
    generated_at_utc: d.generated_at_utc || d.generatedAt || d.meta?.generated_at_utc,
    sections: Array.isArray(d.sections) ? d.sections.map(s => ({id:s.id, title:s.title, items:(s.items||[]).length})) : undefined,
    kpis: d.kpis ? d.kpis : (d.kpi_groups ? d.kpi_groups : undefined),
  };

  if (pre) pre.textContent = JSON.stringify(payload, null, 2);
  modal.style.display = "flex";
}

function _closeSettingsModal(){
  const modal = document.getElementById("settingsModal");
  if (!modal) return;
  modal.style.display = "none";
}

document.addEventListener("DOMContentLoaded", ()=>{
  // Bind buttons by ID if present; otherwise bind by visible text.
  const btnTop = document.getElementById("btnTop") || _findClickableByText("å›åˆ°é¡¶éƒ¨");
  if (btnTop){
    btnTop.addEventListener("click", (e)=>{ e.preventDefault(); _scrollAllToTop(); });
  }

  const btnSettings = document.getElementById("btnSettings") || _findClickableByText("è®¾ç½®");
  if (btnSettings){
    btnSettings.addEventListener("click", (e)=>{ e.preventDefault(); _openSettingsModal(); });
  }

  const modal = document.getElementById("settingsModal");
  const closeBtn = document.getElementById("settingsClose");
  const copyBtn = document.getElementById("settingsCopy");
  const pre = document.getElementById("settingsPre");

  if (closeBtn) closeBtn.addEventListener("click", (e)=>{ e.preventDefault(); _closeSettingsModal(); });
  if (modal) modal.addEventListener("click", (e)=>{ if (e.target === modal) _closeSettingsModal(); });
  document.addEventListener("keydown", (e)=>{ if (e.key === "Escape") _closeSettingsModal(); });

  if (copyBtn){
    copyBtn.addEventListener("click", async (e)=>{
      e.preventDefault();
      try{
        await navigator.clipboard.writeText(pre ? (pre.textContent || "") : "");
        copyBtn.textContent = "å·²å¤åˆ¶";
        setTimeout(()=>copyBtn.textContent="å¤åˆ¶é…ç½®", 1200);
      }catch(err){
        copyBtn.textContent = "å¤åˆ¶å¤±è´¥";
        setTimeout(()=>copyBtn.textContent="å¤åˆ¶é…ç½®", 1200);
      }
    });
  }
});
</script>
</body></html>
