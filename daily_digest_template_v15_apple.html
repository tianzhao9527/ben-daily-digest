<!doctype html>
<html lang="zh-CN"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Daily Digest Â· {{DATE}}</title>
<style>
/* ========== åŸºç¡€å˜é‡ ========== */
:root{
  --bg:#f5f5f7;
  --card:#fff;
  --text:#1d1d1f;
  --muted:#86868b;
  --line:rgba(0,0,0,.08);
  --shadow:0 4px 24px rgba(0,0,0,.06);
  --r:16px;
  --r2:12px;
  --accent:#0071e3;
  --chip:rgba(0,0,0,.04);
  --success:#34c759;
  --danger:#ff3b30;
  --warning:#ff9500;
  --font-sans:-apple-system,BlinkMacSystemFont,"SF Pro Display","SF Pro Text","PingFang SC","Hiragino Sans GB","Microsoft YaHei","Noto Sans CJK SC",system-ui,sans-serif;
}
[data-theme="dark"]{
  --bg:#000;
  --card:rgba(28,28,30,.92);
  --text:#f5f5f7;
  --muted:#98989d;
  --line:rgba(255,255,255,.1);
  --shadow:0 8px 32px rgba(0,0,0,.4);
  --chip:rgba(255,255,255,.06);
}

/* ========== å…¨å±€æ ·å¼ ========== */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:var(--font-sans)}
body{background:var(--bg);color:var(--text);font-size:14px;line-height:1.5}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}

/* ========== å¸ƒå±€ ========== */
.container{
  max-width:1520px;
  margin:0 auto;
  padding:16px;
  display:grid;
  gap:16px;
  grid-template-columns:280px minmax(0,1fr) 360px;
  height:100vh;
  overflow:hidden;
}
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--r);
  box-shadow:var(--shadow);
  overflow:hidden;
  display:flex;
  flex-direction:column;
}

/* ========== å·¦ä¾§æ  ========== */
.left{min-height:0}
.brand{padding:16px;border-bottom:1px solid var(--line)}
.brand-title{font-size:17px;font-weight:700;letter-spacing:-0.3px}
.brand-sub{margin-top:6px;font-size:12px;color:var(--muted);line-height:1.4}
.controls{padding:12px 16px;border-bottom:1px solid var(--line)}
.search{
  width:100%;
  border:1px solid var(--line);
  background:var(--chip);
  padding:10px 12px;
  border-radius:10px;
  outline:none;
  color:var(--text);
  font-size:13px;
  font-family:var(--font-sans);
}
.search:focus{border-color:var(--accent)}
.pills{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.pill{
  font-size:12px;
  padding:6px 12px;
  border-radius:20px;
  border:1px solid var(--line);
  color:var(--muted);
  background:transparent;
  cursor:pointer;
  font-family:var(--font-sans);
  transition:all .15s ease;
}
.pill:hover{background:var(--chip)}
.pill.active{color:#fff;border-color:var(--accent);background:var(--accent)}
.nav{flex:1;overflow:auto;padding:8px}
.nav-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 12px;
  border-radius:10px;
  color:var(--text);
  font-size:13px;
  font-weight:500;
  cursor:pointer;
  transition:background .15s;
  margin-bottom:2px;
}
.nav-item:hover{background:var(--chip)}
.nav-item.active{background:rgba(0,113,227,.1);color:var(--accent)}
.nav-item .badge{
  font-size:11px;
  font-weight:600;
  color:var(--muted);
  background:var(--chip);
  padding:2px 8px;
  border-radius:10px;
}
.nav-item.active .badge{background:rgba(0,113,227,.15);color:var(--accent)}
.left-foot{
  padding:12px 16px;
  border-top:1px solid var(--line);
  display:flex;
  gap:8px;
}
.btn{
  flex:1;
  border:1px solid var(--line);
  background:var(--card);
  color:var(--text);
  padding:8px 12px;
  border-radius:8px;
  font-size:12px;
  font-family:var(--font-sans);
  cursor:pointer;
  transition:all .15s;
}
.btn:hover{background:var(--chip);border-color:var(--accent)}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn.primary:hover{opacity:.9}

/* ========== ä¸­é—´æ  ========== */
.main{min-height:0}
.topbar{
  padding:16px 20px;
  border-bottom:1px solid var(--line);
  background:var(--card);
}
.topbar-title{font-size:20px;font-weight:700;letter-spacing:-0.4px}
.topbar-meta{margin-top:4px;font-size:12px;color:var(--muted)}
.main-scroll{flex:1;overflow:auto;padding:20px}

/* æ¿å—æ ·å¼ */
.section{margin-bottom:32px;scroll-margin-top:20px}
.section-header{margin-bottom:16px}
.section-title{font-size:17px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:8px}
.section-title .cn-badge{
  font-size:10px;
  font-weight:600;
  color:#fff;
  background:var(--danger);
  padding:2px 6px;
  border-radius:4px;
}
/* æ¿å—æ‘˜è¦ï¼ˆå†³ç­–å»ºè®®ï¼‰*/
.section-brief{
  margin-top:12px;
  padding:16px;
  background:linear-gradient(135deg,rgba(0,113,227,.04),rgba(52,199,89,.04));
  border:1px solid rgba(0,113,227,.12);
  border-radius:var(--r2);
  font-size:13px;
  line-height:1.7;
  color:var(--text);
  white-space:pre-wrap;
}
.section-brief strong{color:var(--accent)}

/* å¡ç‰‡ç½‘æ ¼ */
.cards-grid{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:12px;
}
.event-card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--r2);
  padding:16px;
  transition:all .2s ease;
  display:flex;
  flex-direction:column;
}
.event-card:hover{
  border-color:var(--accent);
  box-shadow:0 4px 16px rgba(0,113,227,.1);
  transform:translateY(-2px);
}
.event-card.cn-related{border-left:3px solid var(--danger)}
.event-title{
  font-size:14px;
  font-weight:600;
  line-height:1.4;
  margin-bottom:8px;
  color:var(--text);
}
.event-region{
  display:inline-block;
  font-size:10px;
  font-weight:600;
  padding:2px 6px;
  border-radius:4px;
  margin-bottom:8px;
}
.event-region.cn{background:rgba(255,59,48,.1);color:var(--danger)}
.event-region.us{background:rgba(0,113,227,.1);color:var(--accent)}
.event-region.eu{background:rgba(255,149,0,.1);color:var(--warning)}
.event-region.asia{background:rgba(52,199,89,.1);color:var(--success)}
.event-region.global{background:var(--chip);color:var(--muted)}
.event-summary{
  font-size:13px;
  line-height:1.6;
  color:var(--muted);
  flex:1;
  margin-bottom:12px;
}
.event-sources{
  font-size:11px;
  color:var(--muted);
  border-top:1px solid var(--line);
  padding-top:10px;
  margin-top:auto;
}
.event-sources a{color:var(--accent);font-weight:500}
.event-sources a:hover{text-decoration:underline}
/* åé¦ˆæŒ‰é’® */
.event-footer{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:10px;
  padding-top:10px;
  border-top:1px solid var(--line);
}
.feedback-btns{display:flex;gap:6px}
.fb-btn{
  width:28px;
  height:28px;
  border:1px solid var(--line);
  background:transparent;
  border-radius:6px;
  cursor:pointer;
  font-size:14px;
  transition:all .15s;
}
.fb-btn:hover{background:var(--chip)}
.fb-btn.active.good{background:rgba(52,199,89,.15);border-color:var(--success);color:var(--success)}
.fb-btn.active.bad{background:rgba(255,59,48,.15);border-color:var(--danger);color:var(--danger)}

/* ç©ºçŠ¶æ€ */
.empty{
  padding:40px 20px;
  text-align:center;
  color:var(--muted);
  font-size:13px;
  background:var(--chip);
  border-radius:var(--r2);
  border:1px dashed var(--line);
}

/* ========== å³ä¾§æ  ========== */
.right{min-height:0}
.right-header{
  padding:16px;
  border-bottom:1px solid var(--line);
}
.right-title{font-size:15px;font-weight:700}
.right-sub{margin-top:4px;font-size:11px;color:var(--muted)}
.right-scroll{flex:1;overflow:auto;padding:12px}
.kpi-group{margin-bottom:16px}
.kpi-group-title{
  font-size:11px;
  font-weight:700;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:0.5px;
  padding:8px 4px;
  border-bottom:1px solid var(--line);
  margin-bottom:8px;
}
.kpi-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.kpi-card{
  background:var(--chip);
  border:1px solid var(--line);
  border-radius:10px;
  padding:12px;
}
.kpi-name{
  font-size:11px;
  color:var(--muted);
  font-weight:500;
  display:flex;
  align-items:center;
  gap:6px;
  margin-bottom:6px;
}
.kpi-dot{width:6px;height:6px;border-radius:50%}
.kpi-dot.up{background:var(--success)}
.kpi-dot.down{background:var(--danger)}
.kpi-dot.flat{background:var(--muted)}
.kpi-value{
  font-size:18px;
  font-weight:700;
  color:var(--text);
  font-variant-numeric:tabular-nums;
}
.kpi-unit{font-size:12px;font-weight:400;color:var(--muted);margin-left:2px}
.kpi-delta{font-size:11px;margin-top:4px}
.kpi-delta.up{color:var(--success)}
.kpi-delta.down{color:var(--danger)}
.kpi-delta.flat{color:var(--muted)}
.kpi-spark{width:100%;height:28px;margin-top:8px}
.kpi-spark path.up{stroke:var(--success)}
.kpi-spark path.down{stroke:var(--danger)}
.kpi-spark path.flat{stroke:var(--muted)}
/* åé¦ˆç»Ÿè®¡ */
.feedback-stats{
  margin-top:16px;
  padding:12px;
  background:var(--chip);
  border-radius:10px;
  border:1px solid var(--line);
}
.feedback-stats-title{font-size:12px;font-weight:600;margin-bottom:8px}
.feedback-stats-row{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-bottom:4px}
.feedback-actions{display:flex;gap:8px;margin-top:10px}
.feedback-actions .btn{flex:1;font-size:11px;padding:6px 8px}

/* ========== è®¾ç½®é¢æ¿ ========== */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  backdrop-filter:blur(4px);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:1000;
}
.overlay.show{display:flex}
.settings-panel{
  width:min(600px,90vw);
  max-height:85vh;
  background:var(--card);
  border-radius:var(--r);
  box-shadow:0 20px 60px rgba(0,0,0,.3);
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
.settings-header{
  padding:20px 24px;
  border-bottom:1px solid var(--line);
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.settings-title{font-size:18px;font-weight:700}
.settings-close{
  width:32px;
  height:32px;
  border:none;
  background:var(--chip);
  border-radius:8px;
  cursor:pointer;
  font-size:18px;
  color:var(--muted);
}
.settings-close:hover{background:var(--line);color:var(--text)}
.settings-tabs{
  display:flex;
  gap:4px;
  padding:12px 24px;
  border-bottom:1px solid var(--line);
  background:var(--chip);
}
.settings-tab{
  padding:8px 16px;
  border-radius:8px;
  font-size:13px;
  font-weight:500;
  color:var(--muted);
  cursor:pointer;
  border:none;
  background:transparent;
  font-family:var(--font-sans);
  transition:all .15s;
}
.settings-tab:hover{background:var(--card)}
.settings-tab.active{background:var(--card);color:var(--text);box-shadow:0 2px 8px rgba(0,0,0,.1)}
.settings-body{flex:1;overflow:auto;padding:24px}
.settings-section{margin-bottom:24px}
.settings-section-title{
  font-size:14px;
  font-weight:700;
  margin-bottom:12px;
  color:var(--text);
}
.settings-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 0;
  border-bottom:1px solid var(--line);
}
.settings-row:last-child{border-bottom:none}
.settings-label{
  font-size:13px;
  color:var(--text);
}
.settings-label small{display:block;font-size:11px;color:var(--muted);margin-top:2px}
.settings-input{
  width:140px;
  padding:8px 12px;
  border:1px solid var(--line);
  border-radius:8px;
  font-size:13px;
  font-family:var(--font-sans);
  background:var(--card);
  color:var(--text);
}
.settings-input:focus{outline:none;border-color:var(--accent)}
.settings-select{
  width:140px;
  padding:8px 12px;
  border:1px solid var(--line);
  border-radius:8px;
  font-size:13px;
  font-family:var(--font-sans);
  background:var(--card);
  color:var(--text);
}
.settings-toggle{
  position:relative;
  width:44px;
  height:24px;
  background:var(--line);
  border-radius:12px;
  cursor:pointer;
  transition:background .2s;
}
.settings-toggle.active{background:var(--success)}
.settings-toggle::after{
  content:'';
  position:absolute;
  top:2px;
  left:2px;
  width:20px;
  height:20px;
  background:#fff;
  border-radius:50%;
  transition:transform .2s;
  box-shadow:0 2px 4px rgba(0,0,0,.2);
}
.settings-toggle.active::after{transform:translateX(20px)}
/* é…ç½®é¢„è§ˆ */
.config-preview{
  background:var(--chip);
  border:1px solid var(--line);
  border-radius:8px;
  padding:16px;
  font-family:ui-monospace,monospace;
  font-size:11px;
  line-height:1.5;
  max-height:300px;
  overflow:auto;
  white-space:pre-wrap;
  word-break:break-all;
}

/* ========== å“åº”å¼ ========== */
@media (max-width:1200px){
  .container{grid-template-columns:280px 1fr}
  .right{display:none}
}
@media (max-width:900px){
  .container{grid-template-columns:1fr;height:auto}
  .left{display:none}
  .cards-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<div class="container">
  <!-- å·¦ä¾§æ  -->
  <aside class="card left">
    <div class="brand">
      <div class="brand-title">ğŸ“Š Ben Daily Digest</div>
      <div class="brand-sub">é‡‘å±è´¸æ˜“ Â· åœ°ç¼˜æ”¿æ²» Â· AIç®—åŠ› Â· å¸‚åœºæ•°æ®</div>
    </div>
    <div class="controls">
      <input type="text" class="search" id="searchInput" placeholder="æœç´¢æ–°é—»..."/>
      <div class="pills">
        <button class="pill active" data-view="all">å…¨éƒ¨</button>
        <button class="pill" data-view="cn">ğŸ‡¨ğŸ‡³ ä¸­å›½</button>
        <button class="pill" data-view="global">ğŸŒ å›½é™…</button>
      </div>
    </div>
    <nav class="nav" id="navList"></nav>
    <div class="left-foot">
      <button class="btn" id="btnSettings">âš™ï¸ è®¾ç½®</button>
      <button class="btn" id="btnTop">â†‘ é¡¶éƒ¨</button>
    </div>
  </aside>

  <!-- ä¸­é—´æ  -->
  <main class="card main">
    <div class="topbar">
      <div class="topbar-title" id="pageTitle">æ¯æ—¥ç®€æŠ¥</div>
      <div class="topbar-meta">
        <span id="pageDate">{{DATE}}</span> Â· 
        æ›´æ–°äº <span id="pageTime">â€”</span>
      </div>
    </div>
    <div class="main-scroll" id="mainContent"></div>
  </main>

  <!-- å³ä¾§æ  -->
  <aside class="card right">
    <div class="right-header">
      <div class="right-title">ğŸ“ˆ å…³é”®æŒ‡æ ‡</div>
      <div class="right-sub">æ•°æ®æ¥æº: FRED Â· æ›´æ–°äº <span id="kpiTime">â€”</span></div>
    </div>
    <div class="right-scroll" id="kpiContent"></div>
  </aside>
</div>

<!-- è®¾ç½®é¢æ¿ -->
<div class="overlay" id="settingsOverlay">
  <div class="settings-panel">
    <div class="settings-header">
      <div class="settings-title">âš™ï¸ è®¾ç½®</div>
      <button class="settings-close" id="settingsClose">Ã—</button>
    </div>
    <div class="settings-tabs">
      <button class="settings-tab active" data-tab="general">é€šç”¨</button>
      <button class="settings-tab" data-tab="algo">ç®—æ³•è°ƒä¼˜</button>
      <button class="settings-tab" data-tab="display">æ˜¾ç¤º</button>
      <button class="settings-tab" data-tab="data">æ•°æ®æº</button>
      <button class="settings-tab" data-tab="config">é…ç½®</button>
    </div>
    <div class="settings-body" id="settingsBody"></div>
  </div>
</div>

<script>
window.DIGEST = {{ DIGEST_JSON | safe }};
</script>

<script>
(function(){
  const D = window.DIGEST || {};
  const sections = Array.isArray(D.sections) ? D.sections : [];
  const kpis = Array.isArray(D.kpis) ? D.kpis : [];
  const meta = D.meta || {};

  // State
  let currentView = 'all';
  let searchQuery = '';
  let activeSection = sections[0]?.id || '';
  let feedbackData = JSON.parse(localStorage.getItem('digest_feedback') || '{}');

  // Helpers
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => document.querySelectorAll(sel);
  const esc = (s) => String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const fmtNum = (x, decimals=2) => {
    if (x === null || x === undefined || !isFinite(Number(x))) return 'â€”';
    const n = Number(x);
    if (Math.abs(n) >= 1000) return n.toLocaleString('zh-CN', {maximumFractionDigits: decimals});
    if (Math.abs(n) >= 100) return n.toFixed(1);
    return n.toFixed(decimals).replace(/\.?0+$/, '');
  };

  // Filters
  function passesView(region) {
    if (currentView === 'all') return true;
    if (currentView === 'cn') return region === 'cn';
    if (currentView === 'global') return region !== 'cn';
    return true;
  }
  
  function passesSearch(text) {
    if (!searchQuery) return true;
    return text.toLowerCase().includes(searchQuery.toLowerCase());
  }

  // Render Navigation
  function renderNav() {
    const nav = $('#navList');
    if (!nav) return;
    
    nav.innerHTML = sections.map(sec => {
      const events = (sec.events || []).filter(e => 
        passesView(e.region) && passesSearch(e.title_zh + ' ' + e.summary_zh)
      );
      const cnCount = events.filter(e => e.region === 'cn').length;
      const isActive = sec.id === activeSection;
      
      return `
        <div class="nav-item ${isActive ? 'active' : ''}" data-sid="${esc(sec.id)}">
          <span>${esc(sec.name)}</span>
          <span class="badge">${events.length}${cnCount > 0 ? ' <span style="color:var(--danger)">ğŸ‡¨ğŸ‡³${cnCount}</span>' : ''}</span>
        </div>
      `;
    }).join('');

    $$('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        activeSection = item.dataset.sid;
        renderAll();
        const target = document.querySelector(`[data-section="${activeSection}"]`);
        if (target) target.scrollIntoView({behavior: 'smooth', block: 'start'});
      });
    });
  }

  // Render Main Content
  function renderMain() {
    const main = $('#mainContent');
    if (!main) return;

    const html = sections.map(sec => {
      const events = (sec.events || []).filter(e => 
        passesView(e.region) && passesSearch(e.title_zh + ' ' + e.summary_zh)
      );
      const cnCount = events.filter(e => e.region === 'cn').length;
      const brief = sec.brief_zh || sec.brief_cn || '';

      const cardsHtml = events.length > 0 ? `
        <div class="cards-grid">
          ${events.map((ev, idx) => {
            const evId = `${sec.id}-${idx}`;
            const fb = feedbackData[evId] || 0;
            const sources = (ev.sources || []).slice(0, 3);
            const regionLabels = {cn:'ä¸­å›½',us:'ç¾å›½',eu:'æ¬§æ´²',asia:'äºšæ´²',global:'å…¨çƒ'};
            
            return `
              <div class="event-card ${ev.region === 'cn' ? 'cn-related' : ''}" data-evid="${evId}">
                <span class="event-region ${ev.region || 'global'}">${regionLabels[ev.region] || 'å…¨çƒ'}</span>
                <div class="event-title">${esc(ev.title_zh)}</div>
                <div class="event-summary">${esc(ev.summary_zh)}</div>
                <div class="event-sources">
                  ${sources.map(s => `<a href="${esc(s.url)}" target="_blank">${esc(s.source || s.title || 'æ¥æº')}</a>`).join(' Â· ')}
                </div>
                <div class="event-footer">
                  <span style="font-size:11px;color:var(--muted)">é‡è¦æ€§: ${(ev.score * 100).toFixed(0)}%</span>
                  <div class="feedback-btns">
                    <button class="fb-btn ${fb === 1 ? 'active good' : ''}" data-fb="1" data-evid="${evId}">ğŸ‘</button>
                    <button class="fb-btn ${fb === -1 ? 'active bad' : ''}" data-fb="-1" data-evid="${evId}">ğŸ‘</button>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      ` : '<div class="empty">æš‚æ— ç¬¦åˆæ¡ä»¶çš„å†…å®¹</div>';

      return `
        <section class="section" data-section="${esc(sec.id)}">
          <div class="section-header">
            <div class="section-title">
              ${esc(sec.name)}
              ${cnCount > 0 ? `<span class="cn-badge">ğŸ‡¨ğŸ‡³ ${cnCount}</span>` : ''}
            </div>
          </div>
          ${brief ? `<div class="section-brief">${esc(brief)}</div>` : ''}
          ${cardsHtml}
        </section>
      `;
    }).join('');

    main.innerHTML = html || '<div class="empty">æ²¡æœ‰å¯æ˜¾ç¤ºçš„å†…å®¹</div>';

    // Bind feedback buttons
    $$('.fb-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const evId = btn.dataset.evid;
        const val = parseInt(btn.dataset.fb);
        const current = feedbackData[evId] || 0;
        feedbackData[evId] = (current === val) ? 0 : val;
        localStorage.setItem('digest_feedback', JSON.stringify(feedbackData));
        renderMain();
      });
    });
  }

  // Render KPIs
  function renderKpis() {
    const container = $('#kpiContent');
    if (!container) return;

    // Group KPIs
    const metalsKeywords = ['copper', 'aluminum', 'zinc', 'nickel', 'lead', 'tin', 'é“œ', 'é“', 'é”Œ', 'é•', 'é“…', 'é”¡', 'lme'];
    const metals = [];
    const macro = [];
    
    kpis.forEach(k => {
      const id = (k.id || k.name || '').toLowerCase();
      const bucket = metalsKeywords.some(kw => id.includes(kw)) ? metals : macro;
      bucket.push(k);
    });

    function kpiCard(k) {
      const name = k.name || k.id || 'â€”';
      const val = fmtNum(k.value, 2);
      const unit = k.unit || '';
      const delta = k.delta;
      const deltaPct = k.delta_pct;
      const direction = k.direction || 'flat';
      const color = k.color || '#64748B';
      
      let deltaStr = '';
      if (delta !== null && delta !== undefined && isFinite(delta)) {
        deltaStr = (delta >= 0 ? '+' : '') + fmtNum(delta, 3);
        if (deltaPct !== null && deltaPct !== undefined && isFinite(deltaPct)) {
          deltaStr += ` (${deltaPct >= 0 ? '+' : ''}${deltaPct.toFixed(2)}%)`;
        }
      }

      // Spark SVG
      let sparkHtml = '';
      const series = k.series_values || k.series || [];
      if (series.length >= 2) {
        const w = 100, h = 28, pad = 2;
        const nums = series.map(Number).filter(isFinite);
        if (nums.length >= 2) {
          const min = Math.min(...nums), max = Math.max(...nums);
          const span = (max - min) || 1;
          const pts = nums.map((v, i) => [
            pad + (w - pad * 2) * (i / (nums.length - 1)),
            pad + (h - pad * 2) * (1 - (v - min) / span)
          ]);
          const d = `M ${pts[0][0].toFixed(1)},${pts[0][1].toFixed(1)} ` + 
                    pts.slice(1).map(p => `L ${p[0].toFixed(1)},${p[1].toFixed(1)}`).join(' ');
          sparkHtml = `
            <svg class="kpi-spark" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
              <path class="${direction}" d="${d}" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          `;
        }
      }

      return `
        <div class="kpi-card">
          <div class="kpi-name">
            <span class="kpi-dot ${direction}"></span>
            <span>${esc(name)}</span>
          </div>
          <div class="kpi-value" style="color:${color}">${val}<span class="kpi-unit">${esc(unit)}</span></div>
          <div class="kpi-delta ${direction}">${deltaStr || 'â€”'}</div>
          ${sparkHtml}
        </div>
      `;
    }

    let html = '';
    if (macro.length) {
      html += `
        <div class="kpi-group">
          <div class="kpi-group-title">å®è§‚æŒ‡æ ‡</div>
          <div class="kpi-grid">${macro.map(kpiCard).join('')}</div>
        </div>
      `;
    }
    if (metals.length) {
      html += `
        <div class="kpi-group">
          <div class="kpi-group-title">é‡‘å±ä»·æ ¼</div>
          <div class="kpi-grid">${metals.map(kpiCard).join('')}</div>
        </div>
      `;
    }

    // Feedback stats
    const fbCount = Object.values(feedbackData).filter(v => v !== 0).length;
    const goodCount = Object.values(feedbackData).filter(v => v === 1).length;
    const badCount = Object.values(feedbackData).filter(v => v === -1).length;
    
    html += `
      <div class="feedback-stats">
        <div class="feedback-stats-title">ğŸ“ åé¦ˆç»Ÿè®¡ (æœ¬æœº)</div>
        <div class="feedback-stats-row"><span>å·²åé¦ˆæ¡ç›®</span><span>${fbCount}</span></div>
        <div class="feedback-stats-row"><span>ğŸ‘ æœ‰ä»·å€¼</span><span>${goodCount}</span></div>
        <div class="feedback-stats-row"><span>ğŸ‘ æ— å…³</span><span>${badCount}</span></div>
        <div class="feedback-actions">
          <button class="btn" id="btnExportFb">å¯¼å‡ºåé¦ˆ</button>
          <button class="btn" id="btnClearFb">æ¸…ç©º</button>
        </div>
      </div>
    `;

    container.innerHTML = html || '<div class="empty">æš‚æ—  KPI æ•°æ®</div>';

    // Bind feedback actions
    $('#btnExportFb')?.addEventListener('click', () => {
      const data = JSON.stringify(feedbackData, null, 2);
      const blob = new Blob([data], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `digest_feedback_${D.date || 'export'}.json`;
      a.click();
    });
    
    $('#btnClearFb')?.addEventListener('click', () => {
      if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰åé¦ˆæ•°æ®ï¼Ÿ')) {
        feedbackData = {};
        localStorage.removeItem('digest_feedback');
        renderKpis();
      }
    });
  }

  // Render Settings
  function renderSettings(tab = 'general') {
    const body = $('#settingsBody');
    if (!body) return;

    const tabs = {
      general: `
        <div class="settings-section">
          <div class="settings-section-title">åŸºæœ¬ä¿¡æ¯</div>
          <div class="settings-row">
            <div class="settings-label">ç”Ÿæˆæ—¥æœŸ</div>
            <div>${esc(D.date || 'â€”')}</div>
          </div>
          <div class="settings-row">
            <div class="settings-label">ç”Ÿæˆæ—¶é—´ (åŒ—äº¬æ—¶é—´)</div>
            <div>${esc(D.generated_at_bjt || D.generated_at_utc || 'â€”')}</div>
          </div>
          <div class="settings-row">
            <div class="settings-label">æ¿å—æ•°é‡</div>
            <div>${sections.length}</div>
          </div>
          <div class="settings-row">
            <div class="settings-label">KPI æŒ‡æ ‡æ•°</div>
            <div>${kpis.length}</div>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">ä¸»é¢˜</div>
          <div class="settings-row">
            <div class="settings-label">æ·±è‰²æ¨¡å¼</div>
            <div class="settings-toggle" id="toggleDark"></div>
          </div>
        </div>
      `,
      algo: `
        <div class="settings-section">
          <div class="settings-section-title">ç®—æ³•å‚æ•°</div>
          <div class="settings-row">
            <div class="settings-label">
              LLM æ¨¡å‹
              <small>ç”¨äºç”Ÿæˆæ‘˜è¦å’Œç¿»è¯‘</small>
            </div>
            <div>${esc(meta.model || 'gpt-4o-mini')}</div>
          </div>
          <div class="settings-row">
            <div class="settings-label">
              æ¯æ¿å—æœ€å¤§æ¡ç›®
              <small>items_per_section</small>
            </div>
            <div>${meta.items_per_section || 15}</div>
          </div>
          <div class="settings-row">
            <div class="settings-label">
              åŸå§‹æŠ“å–é™åˆ¶
              <small>limit_raw</small>
            </div>
            <div>${meta.limit_raw || 25}</div>
          </div>
          <div class="settings-row">
            <div class="settings-label">
              ä¸­å›½æŸ¥è¯¢å¢å¼º
              <small>è‡ªåŠ¨æ·»åŠ ä¸­å›½ç›¸å…³æœç´¢è¯</small>
            </div>
            <div>${meta.china_queries_enabled ? 'âœ… å·²å¯ç”¨' : 'âŒ æœªå¯ç”¨'}</div>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">è°ƒä¼˜å»ºè®®</div>
          <div style="font-size:13px;color:var(--muted);line-height:1.6">
            <p>â€¢ å¢åŠ  <code>items_per_section</code> å¯è·å¾—æ›´å¤šäº‹ä»¶å¡</p>
            <p>â€¢ å¢åŠ  <code>limit_raw</code> å¯æ‰©å¤§å€™é€‰æ± </p>
            <p>â€¢ ä½¿ç”¨ gpt-4o å¯æå‡ç¿»è¯‘å’Œæ‘˜è¦è´¨é‡</p>
            <p>â€¢ ä¸­å›½æŸ¥è¯¢å¢å¼ºä¼šä¸ºæ¯ä¸ªæ¿å—æ·»åŠ ä¸“å±ä¸­æ–‡æœç´¢</p>
          </div>
        </div>
      `,
      display: `
        <div class="settings-section">
          <div class="settings-section-title">æ˜¾ç¤ºé€‰é¡¹</div>
          <div class="settings-row">
            <div class="settings-label">å¡ç‰‡å¸ƒå±€åˆ—æ•°</div>
            <select class="settings-select" id="selectCols">
              <option value="1">1 åˆ—</option>
              <option value="2" selected>2 åˆ—</option>
              <option value="3">3 åˆ—</option>
            </select>
          </div>
          <div class="settings-row">
            <div class="settings-label">æ˜¾ç¤ºåé¦ˆæŒ‰é’®</div>
            <div class="settings-toggle active" id="toggleFeedback"></div>
          </div>
          <div class="settings-row">
            <div class="settings-label">æ˜¾ç¤ºæ¥æºé“¾æ¥</div>
            <div class="settings-toggle active" id="toggleSources"></div>
          </div>
        </div>
      `,
      data: `
        <div class="settings-section">
          <div class="settings-section-title">æ•°æ®æºçŠ¶æ€</div>
          <div class="settings-row">
            <div class="settings-label">
              KPI æ•°æ®
              <small>FRED (Federal Reserve)</small>
            </div>
            <div style="color:var(--success)">âœ… æ­£å¸¸</div>
          </div>
          <div class="settings-row">
            <div class="settings-label">
              æ–°é—»æ•°æ®
              <small>Google News RSS</small>
            </div>
            <div style="color:var(--success)">âœ… æ­£å¸¸</div>
          </div>
          <div class="settings-row">
            <div class="settings-label">
              ä¸­å›½æ–°é—»
              <small>Google News zh-CN</small>
            </div>
            <div style="color:var(--success)">âœ… å·²å¯ç”¨</div>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">æ•°æ®æºè¯´æ˜</div>
          <div style="font-size:13px;color:var(--muted);line-height:1.6">
            <p><strong>FRED:</strong> ç¾è”å‚¨ç»æµæ•°æ®ï¼ŒåŒ…æ‹¬åˆ©ç‡ã€æ±‡ç‡ã€å¤§å®—å•†å“ä»·æ ¼</p>
            <p><strong>Google News:</strong> å…¨çƒæ–°é—»èšåˆï¼Œæ”¯æŒå¤šè¯­è¨€æœç´¢</p>
            <p><strong>æ³¨æ„:</strong> éƒ¨åˆ†ç½‘ç«™å¯èƒ½æœ‰è®¿é—®é™åˆ¶ï¼Œå»ºè®®ä½¿ç”¨ä»£ç†</p>
          </div>
        </div>
      `,
      config: `
        <div class="settings-section">
          <div class="settings-section-title">ç”Ÿæˆå™¨é…ç½®</div>
          <div class="config-preview" id="configPreview">${JSON.stringify(meta, null, 2)}</div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn" id="btnCopyConfig">å¤åˆ¶é…ç½®</button>
            <button class="btn" id="btnExportDigest">å¯¼å‡ºå®Œæ•´æ•°æ®</button>
          </div>
        </div>
      `
    };

    body.innerHTML = tabs[tab] || tabs.general;

    // Bind settings interactions
    $('#toggleDark')?.addEventListener('click', function() {
      this.classList.toggle('active');
      document.documentElement.setAttribute('data-theme', this.classList.contains('active') ? 'dark' : 'light');
    });

    $('#btnCopyConfig')?.addEventListener('click', () => {
      navigator.clipboard.writeText(JSON.stringify(meta, null, 2));
      alert('é…ç½®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    });

    $('#btnExportDigest')?.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(D, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `digest_${D.date || 'export'}.json`;
      a.click();
    });
  }

  // Render All
  function renderAll() {
    renderNav();
    renderMain();
    renderKpis();
    
    // Update header
    $('#pageDate').textContent = D.date || 'â€”';
    $('#pageTime').textContent = D.generated_at_bjt || D.generated_at_utc || 'â€”';
    $('#kpiTime').textContent = D.generated_at_bjt || D.generated_at_utc || 'â€”';
  }

  // Bind Controls
  function bindControls() {
    // Search
    $('#searchInput')?.addEventListener('input', (e) => {
      searchQuery = e.target.value;
      renderAll();
    });

    // View pills
    $$('.pill').forEach(pill => {
      pill.addEventListener('click', () => {
        $$('.pill').forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
        currentView = pill.dataset.view;
        renderAll();
      });
    });

    // Settings
    $('#btnSettings')?.addEventListener('click', () => {
      $('#settingsOverlay').classList.add('show');
      renderSettings('general');
    });
    
    $('#settingsClose')?.addEventListener('click', () => {
      $('#settingsOverlay').classList.remove('show');
    });
    
    $('#settingsOverlay')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) {
        $('#settingsOverlay').classList.remove('show');
      }
    });

    // Settings tabs
    $$('.settings-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        $$('.settings-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        renderSettings(tab.dataset.tab);
      });
    });

    // Scroll to top
    $('#btnTop')?.addEventListener('click', () => {
      $('#mainContent')?.scrollTo({top: 0, behavior: 'smooth'});
    });

    // Keyboard
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        $('#settingsOverlay').classList.remove('show');
      }
    });
  }

  // Boot
  bindControls();
  renderAll();
})();
</script>

</body>
</html>
